<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>启敏信息技术 - IT信息维护系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 全局样式 */
        :root {
            --primary: #1a73e8;
            --secondary: #0f3057;
            --accent: #00c9ff;
            --dark: #0a1929;
            --light: #f8f9fa;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray: #6c757d;
            --card-bg: rgba(255, 255, 255, 0.08);
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f3057, #0a1929);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(rgba(10, 25, 41, 0.9), rgba(15, 48, 87, 0.9)), 
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230a1929"/><path d="M0 50 L100 50 M50 0 L50 100" stroke="%231a73e8" stroke-width="0.5" stroke-opacity="0.3"/></svg>');
            background-size: cover;
        }
        
        .login-box {
            background: rgba(26, 35, 47, 0.85);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(26, 115, 232, 0.3),
                        0 0 20px rgba(0, 201, 255, 0.2);
            width: 400px;
            max-width: 90vw;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, var(--accent), transparent 30%);
            animation: rotate 6s linear infinite;
            z-index: -1;
        }
        
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        
        .login-box h2 {
            color: var(--accent);
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .login-box p {
            color: #a0aec0;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .input-group {
            position: relative;
            margin-bottom: 25px;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(10, 25, 41, 0.7);
            border: 1px solid rgba(26, 115, 232, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 201, 255, 0.2);
        }
        
        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
        }
        
        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            letter-spacing: 1px;
        }
        
        .btn-login:hover {
            background: linear-gradient(90deg, var(--accent), var(--primary));
            box-shadow: 0 0 15px rgba(0, 201, 255, 0.4);
        }
        
        .main-container {
            display: none;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 30, 50, 0.9);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(26, 115, 232, 0.2);
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .logo {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(26, 115, 232, 0.3);
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            color: var(--accent);
            letter-spacing: 1px;
        }
        
        .logo span {
            font-size: 12px;
            color: #6c757d;
            letter-spacing: 2px;
        }
        
        .nav-links {
            padding: 0 20px;
        }
        
        .nav-item {
            padding: 14px 20px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            color: #a0aec0;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(26, 115, 232, 0.2);
            color: var(--accent);
        }
        
        .nav-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 25px;
            text-align: center;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            font-size: 24px;
            letter-spacing: 1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .company-intro {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(26, 115, 232, 0.2);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .company-intro h3 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 20px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .company-intro p {
            line-height: 1.8;
            margin-bottom: 15px;
            color: #cbd5e0;
        }
        
        .services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .service-card {
            background: rgba(15, 30, 50, 0.7);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(26, 115, 232, 0.2);
            transition: transform 0.3s;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }
        
        .service-card i {
            font-size: 36px;
            color: var(--accent);
            margin-bottom: 20px;
        }
        
        .service-card h4 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .service-card p {
            color: #a0aec0;
            line-height: 1.6;
        }
        
        .form-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(26, 115, 232, 0.2);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .form-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-header h3 {
            color: var(--accent);
            font-size: 22px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            background: rgba(10, 25, 41, 0.7);
            border: 1px solid rgba(26, 115, 232, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 201, 255, 0.2);
        }
        
        .btn-submit {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border: none;
            padding: 12px 30px;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-submit:hover {
            background: linear-gradient(90deg, var(--accent), var(--primary));
            box-shadow: 0 0 15px rgba(0, 201, 255, 0.4);
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-header h3 {
            color: var(--accent);
            font-size: 18px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            margin-bottom: 12px;
        }
        
        .info-item label {
            display: block;
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .info-item span {
            color: #cbd5e0;
            font-size: 16px;
        }
        
        .task-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .task-card {
            background: rgba(15, 30, 50, 0.7);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(26, 115, 232, 0.2);
            transition: all 0.3s;
        }
        
        .task-card:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .task-card h4 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
            color: #a0aec0;
        }
        
        .task-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 4px;
        }
        
        .btn-task {
            background: rgba(26, 115, 232, 0.2);
            border: 1px solid rgba(26, 115, 232, 0.5);
            color: var(--accent);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-task:hover {
            background: rgba(26, 115, 232, 0.4);
            color: white;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        
        .stat-card i {
            font-size: 40px;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .stat-card p {
            color: #a0aec0;
            font-size: 16px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #6c757d;
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 文件上传容器 */
        .file-upload-container {
            margin-bottom: 15px;
            position: relative;
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            background: rgba(26, 115, 232, 0.2);
            border: 1px solid rgba(26, 115, 232, 0.5);
            color: var(--accent);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            width: 100%;
        }
        
        .file-upload-btn:hover {
            background: rgba(26, 115, 232, 0.4);
            color: white;
        }
        
        .file-name {
            color: #cbd5e0;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
        
        .file-remove {
            position: absolute;
            right: 10px;
            top: 8px;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--danger);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .file-remove:hover {
            background: rgba(220, 53, 69, 0.4);
        }
        
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(10, 25, 41, 0.5);
            margin-bottom: 8px;
            border-radius: 6px;
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-actions button {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--danger);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .device-actions button:hover {
            background: rgba(220, 53, 69, 0.4);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--dark);
            border-radius: 12px;
            padding: 30px;
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            overflow: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h3 {
            color: var(--accent);
            font-family: 'Orbitron', sans-serif;
        }
        
        .close-modal {
            color: #a0aec0;
            font-size: 24px;
            cursor: pointer;
        }
        
        .preview-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .preview-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid rgba(26, 115, 232, 0.3);
        }
        
        .preview-container iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
            background: white;
        }
        
        .device-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .device-form-group {
            margin-bottom: 15px;
        }
        
        .device-form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--accent);
            font-size: 14px;
        }
        
        .device-form-group input, .device-form-group select, .device-form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(10, 25, 41, 0.7);
            border: 1px solid rgba(26, 115, 232, 0.3);
            border-radius: 6px;
            color: white;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        /* 工程师表单样式 */
        .engineer-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .engineer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(10, 25, 41, 0.5);
            margin-bottom: 8px;
            border-radius: 6px;
        }
        
        .engineer-info {
            flex: 1;
        }
        
        .engineer-actions button {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--danger);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .engineer-actions button:hover {
            background: rgba(220, 53, 69, 0.4);
            color: white;
        }
        
        /* 缩略图样式 */
        .thumbnail-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .thumbnail {
            width: 150px;
            height: 120px;
            border-radius: 6px;
            border: 1px solid rgba(26, 115, 232, 0.3);
            object-fit: cover;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
        }
        
        .thumbnail:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }
        
        .thumbnail-actions {
            display: flex;
            gap: 5px;
        }
        
        .thumbnail-action-btn {
            background: rgba(26, 115, 232, 0.2);
            border: 1px solid rgba(26, 115, 232, 0.5);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .thumbnail-action-btn:hover {
            background: rgba(26, 115, 232, 0.4);
            color: white;
        }
        
        /* 工程师卡片样式 */
        .engineer-card {
            background: rgba(15, 30, 50, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        /* 预览大图样式 */
        .preview-large {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 8px;
            border: 2px solid var(--accent);
        }
        
        /* 巡检内容样式 */
        .inspection-form {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        
        .inspection-step {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .inspection-step h4 {
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .step-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .step-content textarea {
            min-height: 100px;
        }
        
        .image-upload-container {
            margin-top: 15px;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview {
            position: relative;
            width: 150px;
            height: 120px;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(26, 115, 232, 0.3);
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .history-container {
            margin-top: 30px;
        }
        
        .history-item {
            background: rgba(15, 30, 50, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-content {
            padding: 10px;
            background: rgba(10, 25, 41, 0.3);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .history-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .history-image {
            width: 120px;
            height: 90px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .inspection-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-save {
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .btn-cancel {
            background: rgba(108, 117, 125, 0.5);
        }
        
        .btn-complete {
            background: linear-gradient(90deg, var(--success), #4CAF50);
        }
        
        /* 报告样式 */
        .report-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .report-header h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            font-size: 28px;
            letter-spacing: 1px;
        }
        
        .report-subtitle {
            color: #a0aec0;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h4 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }
        
        .report-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-info-item {
            margin-bottom: 12px;
        }
        
        .report-info-item label {
            display: block;
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .report-info-item span {
            color: #cbd5e0;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .report-table th {
            background: rgba(26, 115, 232, 0.2);
            color: var(--accent);
            font-weight: 500;
        }
        
        .report-table tr:hover {
            background: rgba(26, 115, 232, 0.1);
        }
        
        .report-image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .report-image {
            width: 250px;
            height: 180px;
            border-radius: 8px;
            border: 1px solid rgba(26, 115, 232, 0.3);
            object-fit: cover;
        }
        
        .report-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .report-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .report-card {
            background: rgba(15, 30, 50, 0.7);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(26, 115, 232, 0.2);
            transition: all 0.3s;
        }
        
        .report-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .report-card h4 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .report-card p {
            color: #a0aec0;
            margin-bottom: 12px;
        }
        
        .report-card .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .status-completed {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .status-in-progress {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .report-card .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-export {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
            color: var(--success);
        }
        
        .btn-export:hover {
            background: rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .btn-delete {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--danger);
        }
        
        .btn-delete:hover {
            background: rgba(220, 53, 69, 0.4);
            color: white;
        }
        
        .report-summary {
            background: rgba(26, 115, 232, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .report-summary h5 {
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .report-summary p {
            line-height: 1.6;
        }

        /* 维修工单样式 */
        .repair-card {
            background: rgba(15, 30, 50, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        
        .repair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .repair-header h4 {
            color: var(--accent);
            font-size: 18px;
        }
        
        .repair-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .repair-info-item {
            margin-bottom: 10px;
        }
        
        .repair-info-item label {
            display: block;
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .repair-info-item span {
            color: #cbd5e0;
            font-size: 16px;
        }
        
        .repair-description {
            background: rgba(10, 25, 41, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .repair-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 维修表单样式 */
        .repair-form-group {
            margin-bottom: 20px;
        }
        
        .repair-form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: 500;
        }
        
        /* 分页样式 */
        .page-break {
            page-break-after: always;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        
        /* 项目详情模态框 */
        .project-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .project-detail-content {
            background: var(--dark);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: auto;
        }
        
        /* 文件预览链接 */
        .file-preview-link {
            color: var(--accent);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
        }
        
        /* 删除历史记录按钮 */
        .delete-history-btn {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--danger);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .delete-history-btn:hover {
            background: rgba(220, 53, 69, 0.4);
            color: white;
        }
        
        /* 维修按钮样式 */
        .btn-repair {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: var(--warning);
            margin-top: 10px;
        }
        
        .btn-repair:hover {
            background: rgba(255, 193, 7, 0.4);
            color: white;
        }
        
        /* 状态标签 */
        .status-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-new {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
        }
        
        .status-in-progress {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .status-completed {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }

        /* 用户管理表格 */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-table th {
            background: rgba(26, 115, 232, 0.2);
            color: var(--accent);
            font-weight: 500;
        }
        
        .user-table tr:hover {
            background: rgba(26, 115, 232, 0.1);
        }
        
        .role-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .role-manager {
            background: rgba(26, 115, 232, 0.2);
            color: var(--primary);
        }
        
        .role-it {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .role-business {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .role-admin {
            background: rgba(153, 102, 255, 0.2);
            color: #9966ff;
        }
        
        .permission-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #cbd5e0;
        }
        
        /* 用户表单样式 */
        .user-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 备份管理 */
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(10, 25, 41, 0.5);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .backup-info {
            flex: 1;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 权限管理 */
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .permission-card {
            background: rgba(15, 30, 50, 0.5);
            border-radius: 8px;
            padding: 15px;
        }
        
        .permission-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .permission-check {
            margin-right: 10px;
        }
        
        /* PDF导出样式 */
        .pdf-content {
            position: fixed;
            top: -10000px;
            left: -10000px;
            width: 1000px;
            background: white;
            color: black;
            padding: 40px;
            z-index: -1000;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .sidebar .logo h1, .sidebar .logo span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
                padding: 15px;
            }
            
            .nav-item {
                justify-content: center;
                padding: 14px 10px;
            }
            
            .nav-item i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .company-intro, .form-container {
                padding: 20px;
            }
            
            .services, .task-list, .report-list {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .device-form {
                grid-template-columns: 1fr;
            }
            
            .step-content {
                grid-template-columns: 1fr;
            }
            
            .report-info-grid, .project-info, .repair-info {
                grid-template-columns: 1fr;
            }
            
            .modal-content, .project-detail-content {
                width: 95%;
                padding: 15px;
            }
            
            .thumbnail-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .thumbnail {
                margin-bottom: 10px;
            }
            
            .inspection-actions, .report-actions, .repair-actions {
                flex-wrap: wrap;
            }
            
            .btn-submit, .btn-task {
                width: 100%;
                margin-top: 10px;
            }
            
            .task-card, .report-card, .repair-card {
                padding: 15px;
            }
            
            .form-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            #projectSearch, #reportSearch, #repairSearch {
                width: 100%;
            }
            
            .engineer-form {
                grid-template-columns: 1fr;
            }
            
            .report-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .image-preview {
                width: 120px;
                height: 90px;
            }
            
            .history-image {
                width: 100px;
                height: 75px;
            }
            
            .user-form {
                grid-template-columns: 1fr;
            }
        }
        
        /* 小屏幕手机优化 */
        @media (max-width: 480px) {
            .login-box {
                padding: 20px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .header h2 {
                font-size: 20px;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-end;
                gap: 5px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .company-intro h3 {
                font-size: 20px;
            }
            
            .service-card {
                padding: 15px;
            }
            
            .service-card i {
                font-size: 28px;
            }
            
            .thumbnail {
                width: 120px;
                height: 100px;
            }
            
            .report-image {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .preview-container iframe {
                height: 300px;
            }
            
            .footer {
                font-size: 12px;
            }
        }

        /* 退出按钮样式 */
        .logout-btn {
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h2>启敏信息技术</h2>
            <p>IT信息维护系统</p>
            
            <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="username" placeholder="用户名" onkeydown="handleKeyDown(event)">
            </div>
            
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="密码" onkeydown="handleKeyDown(event)">
            </div>
            
            <button class="btn-login" onclick="login()">登录系统</button>
        </div>
    </div>
    
    <!-- 主系统界面 -->
    <div class="main-container" id="mainSystem">
        <!-- 左侧导航栏 -->
        <div class="sidebar">
            <div class="logo">
                <h1>启敏信息</h1>
                <span>IT MAINTENANCE SYSTEM</span>
            </div>
            
            <div class="nav-links">
                <div class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">首页</span>
                </div>
                <div class="nav-item" data-page="newProject">
                    <i class="fas fa-plus-circle"></i>
                    <span class="nav-text">新建项目</span>
                </div>
                <div class="nav-item" data-page="projectManagement">
                    <i class="fas fa-tasks"></i>
                    <span class="nav-text">项目管理</span>
                </div>
                <div class="nav-item" data-page="inspectionTasks">
                    <i class="fas fa-clipboard-check"></i>
                    <span class="nav-text">巡检任务</span>
                </div>
                <div class="nav-item" data-page="reports">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-text">巡检报告</span>
                </div>
                <div class="nav-item" data-page="repairWork">
                    <i class="fas fa-wrench"></i>
                    <span class="nav-text">维修工单</span>
                </div>
                <div class="nav-item" data-page="systemSettings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">系统设置</span>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 顶部标题栏 -->
            <div class="header">
                <h2 id="pageTitle">IT系统运维管理平台</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">张</div>
                    <div>
                        <div id="userName">张工程师</div>
                        <div style="font-size: 12px; color: #6c757d;" id="userRole">系统管理员</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> 退出系统
                    </button>
                </div>
            </div>
            
            <!-- 首页/公司介绍 -->
            <div class="page-content active" id="homePage">
                <div class="company-intro">
                    <h3>启敏信息技术（浙江）有限公司</h3>
                    <p>启敏信息技术成立于2021年，是一家专注于企业级IT基础设施维护与智能化系统服务的高科技企业。公司总部位于绍兴，业务覆盖绍兴全市，为超过100家企业客户提供专业的IT运维服务。</p>
                    <p>我们拥有超过50人的专业技术团队，持有多项行业认证，包括CCIE、RHCE、VMware认证专家等，为客户提供7×24小时全天候技术支持服务。</p>
                    <p>公司秉承"技术为本，服务至上"的理念，致力于为企业客户打造稳定、安全、高效的IT运行环境，助力企业数字化转型。</p>
                    
                    <div class="services">
                        <div class="service-card">
                            <i class="fas fa-server"></i>
                            <h4>机房硬件维护</h4>
                            <p>服务器、存储设备、网络设备等硬件设施的日常维护、故障诊断与处理、备件更换、性能优化等服务。</p>
                        </div>
                        
                        <div class="service-card">
                            <i class="fas fa-code"></i>
                            <h4>软件系统维护</h4>
                            <p>操作系统、数据库、中间件、应用软件等系统的安装部署、升级维护、性能调优、安全加固等服务。</p>
                        </div>
                        
                        <div class="service-card">
                            <i class="fas fa-building"></i>
                            <h4>智能化系统维保</h4>
                            <p>楼宇自控系统、安防监控系统、门禁系统、智能照明系统等智能化系统的日常维护与故障处理。</p>
                        </div>
                        
                        <div class="service-card">
                            <i class="fas fa-shield-alt"></i>
                            <h4>信息安全服务</h4>
                            <p>网络安全评估、漏洞扫描、渗透测试、安全加固、应急响应等全方位信息安全服务。</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <i class="fas fa-project-diagram"></i>
                        <h3 id="activeProjectsCount">0</h3>
                        <p>在维保项目</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3 id="monthlyTasksCount">0</h3>
                        <p>本月巡检任务</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="completionRate">0%</h3>
                        <p>任务完成率</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-tools"></i>
                        <h3 id="repairCount">0</h3>
                        <p>待处理维修</p>
                    </div>
                </div>
            </div>
            
            <!-- 新建项目 -->
            <div class="page-content" id="newProjectPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>新建维护项目</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectName">项目名称</label>
                            <input type="text" id="projectName" class="form-control" placeholder="请输入项目名称">
                        </div>
                        
                        <div class="form-group">
                            <label for="client">甲方单位</label>
                            <input type="text" id="client" class="form-control" placeholder="请输入甲方单位">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactPerson">联系人</label>
                            <input type="text" id="contactPerson" class="form-control" placeholder="请输入联系人姓名">
                        </div>
                        
                        <div class="form-group">
                            <label for="contactPhone">联系方式</label>
                            <input type="text" id="contactPhone" class="form-control" placeholder="请输入联系电话">
                        </div>
                    </div>
                    
                    <!-- 服务工程师手动输入部分 -->
                    <div class="form-group">
                        <label>服务工程师</label>
                        <div class="engineer-form">
                            <div class="form-group">
                                <input type="text" id="engineerName" class="form-control" placeholder="工程师姓名">
                            </div>
                            <div class="form-group">
                                <input type="text" id="engineerPhone" class="form-control" placeholder="联系方式">
                            </div>
                            <div class="form-group">
                                <input type="text" id="engineerPosition" class="form-control" placeholder="职位">
                            </div>
                            <div class="form-group">
                                <button class="btn-submit" onclick="addEngineer()" style="margin-top: 0;">添加工程师</button>
                            </div>
                        </div>
                        
                        <div id="engineersContainer" style="margin-top: 15px;">
                            <div style="color: #a0aec0; margin-bottom: 10px;">已添加工程师：</div>
                            <div id="engineersList">暂无工程师</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="inspectionContent">巡检内容</label>
                        <textarea id="inspectionContent" class="form-control" rows="3" placeholder="请输入巡检内容要求"></textarea>
                        
                        <div class="file-upload-container">
                            <input type="file" id="inspectionDoc" class="file-input" accept=".doc,.docx,.pdf,.xls,.xlsx,.txt,.jpg,.jpeg,.png">
                            <label for="inspectionDoc" class="file-upload-btn">
                                <i class="fas fa-upload"></i> 上传巡检文档
                            </label>
                            <span id="inspectionDocName" class="file-name">未选择文件</span>
                            <div class="file-remove" id="removeInspectionDoc" style="display: none;">×</div>
                        </div>
                    </div>
                    
                    <!-- 拓扑图上传与预览 -->
                    <div class="form-group">
                        <label>系统拓扑图</label>
                        <div class="file-upload-container">
                            <input type="file" id="topologyFile" class="file-input" accept=".jpg,.jpeg,.png,.gif,.svg" onchange="handleTopologyUpload(event)">
                            <label for="topologyFile" class="file-upload-btn">
                                <i class="fas fa-upload"></i> 上传拓扑图
                            </label>
                            <span id="topologyFileName" class="file-name">未选择文件</span>
                            <div class="file-remove" id="removeTopology" style="display: none;">×</div>
                        </div>
                        
                        <div id="topologyPreview" class="thumbnail-container" style="display: none;">
                            <img id="topologyThumbnail" class="thumbnail" alt="拓扑图预览" onclick="previewLargeImage()">
                            <div class="thumbnail-actions">
                                <button class="thumbnail-action-btn" onclick="previewLargeImage()">查看大图</button>
                                <button class="thumbnail-action-btn" onclick="removeTopology()">删除</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">巡检开始日期</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="endDate">巡检结束日期</label>
                            <input type="date" id="endDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="frequency">巡检频率</label>
                        <select id="frequency" class="form-control">
                            <option value="monthly">每月一次</option>
                            <option value="quarterly">每季度一次</option>
                            <option value="half-year">每半年一次</option>
                            <option value="yearly">每年一次</option>
                        </select>
                    </div>
                    
                    <!-- 添加巡检设备/服务 -->
                    <div class="form-group">
                        <label>添加巡检设备/服务</label>
                        <div class="device-form">
                            <div class="device-form-group">
                                <label>名称</label>
                                <input type="text" id="deviceName" placeholder="输入设备/服务名称">
                            </div>
                            
                            <div class="device-form-group">
                                <label>设备类型/服务类型</label>
                                <select id="deviceType">
                                    <option value="server">服务器</option>
                                    <option value="network">网络设备</option>
                                    <option value="storage">存储设备</option>
                                    <option value="security">安全设备</option>
                                    <option value="other">其他设备/服务</option>
                                </select>
                            </div>
                            
                            <div class="device-form-group">
                                <label>型号/版本</label>
                                <input type="text" id="deviceModel" placeholder="输入型号或版本">
                            </div>
                            
                            <div class="device-form-group">
                                <label>序列号</label>
                                <input type="text" id="deviceSerial" placeholder="输入序列号">
                            </div>
                            
                            <div class="device-form-group">
                                <label>数量/单位</label>
                                <input type="text" id="deviceQuantity" placeholder="例如: 2台">
                            </div>
                            
                            <div class="device-form-group">
                                <label>位置</label>
                                <input type="text" id="deviceLocation" placeholder="设备位置">
                            </div>
                            
                            <div class="device-form-group">
                                <label>服务内容</label>
                                <input type="text" id="deviceService" placeholder="服务内容">
                            </div>
                        </div>
                        
                        <button class="btn-submit" onclick="addDevice()" style="margin-top: 0;">添加设备/服务</button>
                        
                        <div id="deviceList" style="margin-top: 15px; background: rgba(10,25,41,0.5); padding: 15px; border-radius: 8px;">
                            <div style="color: #a0aec0; margin-bottom: 10px;">已添加设备/服务：</div>
                            <div id="devicesContainer">暂无设备/服务</div>
                        </div>
                    </div>
                    
                    <button class="btn-submit" onclick="createProject()">创建项目</button>
                </div>
            </div>
            
            <!-- 项目管理 -->
            <div class="page-content" id="projectManagementPage">
                <div class="form-container">
                    <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>项目管理</h3>
                        <div>
                            <input type="text" id="projectSearch" class="form-control" placeholder="搜索项目..." style="display: inline-block; width: auto;">
                        </div>
                    </div>
                    
                    <div id="projectsContainer">
                        <!-- 项目卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 巡检任务 -->
            <div class="page-content" id="inspectionTasksPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>巡检任务</h3>
                    </div>
                    
                    <div class="task-list" id="tasksContainer">
                        <!-- 巡检任务将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 巡检详情 -->
            <div class="page-content" id="inspectionDetailPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>巡检任务详情</h3>
                        <div id="inspectionProjectInfo"></div>
                    </div>
                    
                    <div id="inspectionStepsContainer">
                        <!-- 巡检步骤将通过JavaScript动态生成 -->
                    </div>
                    
                    <div id="inspectionHistoryContainer" class="history-container">
                        <h3 style="color: var(--accent); margin-bottom: 15px;">历史巡检记录</h3>
                        <div id="inspectionHistoryList">
                            <!-- 历史记录将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <div class="inspection-actions">
                        <button class="btn-submit btn-save" onclick="saveInspection()">保存进度</button>
                        <button class="btn-submit btn-cancel" onclick="cancelInspection()">取消</button>
                        <button class="btn-submit btn-complete" onclick="completeInspection()">完成巡检</button>
                    </div>
                </div>
            </div>
            
            <!-- 巡检报告管理 -->
            <div class="page-content" id="reportsPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>巡检报告管理</h3>
                        <div>
                            <input type="text" id="reportSearch" class="form-control" placeholder="搜索报告..." style="display: inline-block; width: auto;">
                        </div>
                    </div>
                    
                    <div class="report-list" id="reportsContainer">
                        <!-- 报告卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 报告详情页面 -->
            <div class="page-content" id="reportDetailPage">
                <div class="form-container">
                    <div class="report-header">
                        <h3 id="reportTitle">巡检报告</h3>
                        <div class="report-subtitle" id="reportSubtitle">启敏信息技术（浙江）有限公司</div>
                    </div>
                    
                    <div id="reportContent">
                        <!-- 报告内容将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="report-actions">
                        <button class="btn-task btn-export" onclick="exportReport()">
                            <i class="fas fa-download"></i> 导出PDF
                        </button>
                        <button class="btn-task" onclick="printReport()">
                            <i class="fas fa-print"></i> 打印报告
                        </button>
                        <button class="btn-task" onclick="backToReportList()">
                            <i class="fas fa-arrow-left"></i> 返回列表
                        </button>
                        <button class="btn-task btn-delete" onclick="deleteReport()">
                            <i class="fas fa-trash"></i> 删除报告
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 维修工单管理 -->
            <div class="page-content" id="repairWorkPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>维修工单管理</h3>
                        <div>
                            <input type="text" id="repairSearch" class="form-control" placeholder="搜索工单..." style="display: inline-block; width: auto;">
                            <button class="btn-submit" onclick="openNewRepairForm()" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> 新建工单
                            </button>
                        </div>
                    </div>
                    
                    <div id="repairsContainer">
                        <!-- 维修工单将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 维修工单详情 -->
            <div class="page-content" id="repairDetailPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3 id="repairDetailTitle">维修工单详情</h3>
                        <div id="repairProjectInfo"></div>
                    </div>
                    
                    <div id="repairDetailContent">
                        <!-- 维修工单详情将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="inspection-actions">
                        <button class="btn-submit" onclick="saveRepair()">保存修改</button>
                        <button class="btn-submit btn-cancel" onclick="backToRepairList()">返回列表</button>
                        <button class="btn-submit btn-complete" onclick="completeRepair()">完成维修</button>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置 -->
            <div class="page-content" id="systemSettingsPage">
                <div class="form-container">
                    <div class="form-header">
                        <h3>系统设置</h3>
                    </div>
                    
                    <!-- 用户管理 -->
                    <div class="card">
                        <div class="card-header">
                            <h3>用户管理</h3>
                            <button class="btn-task" onclick="showUserForm()"><i class="fas fa-plus"></i> 添加用户</button>
                        </div>
                        
                        <div id="userListContainer">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>角色</th>
                                        <th>权限</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <!-- 用户数据将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 添加/编辑用户表单 -->
                    <div class="card" id="userFormContainer" style="display: none;">
                        <div class="card-header">
                            <h3 id="userFormTitle">添加用户</h3>
                        </div>
                        
                        <div class="user-form">
                            <div class="form-group">
                                <label for="usernameInput">用户名</label>
                                <input type="text" id="usernameInput" class="form-control" placeholder="输入用户名">
                            </div>
                            
                            <div class="form-group">
                                <label for="passwordInput">密码</label>
                                <input type="password" id="passwordInput" class="form-control" placeholder="输入密码">
                            </div>
                            
                            <div class="form-group">
                                <label for="fullNameInput">姓名</label>
                                <input type="text" id="fullNameInput" class="form-control" placeholder="输入姓名">
                            </div>
                            
                            <div class="form-group">
                                <label for="roleSelect">角色</label>
                                <select id="roleSelect" class="form-control">
                                    <option value="manager">经理</option>
                                    <option value="it">IT服务人员</option>
                                    <option value="business">商务</option>
                                    <option value="admin">管理员</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="card-header">
                            <h3>权限设置</h3>
                        </div>
                        
                        <div class="permission-grid">
                            <div class="permission-card">
                                <div class="permission-header">
                                    <input type="checkbox" id="permRead" class="permission-check" checked>
                                    <label for="permRead">读权限</label>
                                </div>
                                <p>允许查看所有系统数据</p>
                            </div>
                            
                            <div class="permission-card">
                                <div class="permission-header">
                                    <input type="checkbox" id="permWrite" class="permission-check" checked>
                                    <label for="permWrite">写权限</label>
                                </div>
                                <p>允许创建和修改数据</p>
                            </div>
                            
                            <div class="permission-card">
                                <div class="permission-header">
                                    <input type="checkbox" id="permDelete" class="permission-check" checked>
                                    <label for="permDelete">删除权限</label>
                                </div>
                                <p>允许删除系统数据</p>
                            </div>
                            
                            <div class="permission-card">
                                <div class="permission-header">
                                    <input type="checkbox" id="permAdmin" class="permission-check">
                                    <label for="permAdmin">管理员权限</label>
                                </div>
                                <p>允许管理系统设置</p>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn-submit" onclick="saveUser()">保存用户</button>
                            <button class="btn-submit btn-cancel" onclick="hideUserForm()">取消</button>
                        </div>
                    </div>
                    
                    <!-- 数据备份 -->
                    <div class="card">
                        <div class="card-header">
                            <h3>数据备份</h3>
                        </div>
                        
                        <div class="project-info">
                            <div class="info-item">
                                <label>最后备份</label>
                                <span id="lastBackup">2023-11-25 03:00:00</span>
                            </div>
                            <div class="info-item">
                                <label>备份周期</label>
                                <span>每天 03:00 AM</span>
                            </div>
                            <div class="info-item">
                                <label>备份位置</label>
                                <span>/backup/system</span>
                            </div>
                        </div>
                        
                        <button class="btn-task" onclick="backupData()">
                            <i class="fas fa-download"></i> 备份数据
                        </button>
                        
                        <div class="file-upload-container">
                            <input type="file" id="restoreFile" class="file-input" accept=".json" onchange="handleRestoreFile(event)">
                            <label for="restoreFile" class="file-upload-btn" style="margin-top: 10px;">
                                <i class="fas fa-upload"></i> 选择恢复文件
                            </label>
                            <span id="restoreFileName" class="file-name">未选择文件</span>
                        </div>
                        
                        <button class="btn-task" id="restoreBtn" onclick="restoreData()" disabled style="margin-top: 10px;">
                            <i class="fas fa-upload"></i> 恢复数据
                        </button>
                    </div>
                    
                    <!-- 系统维护 -->
                    <div class="card">
                        <div class="card-header">
                            <h3>系统维护</h3>
                        </div>
                        <div class="project-info">
                            <div class="info-item">
                                <label>系统版本</label>
                                <span>v2.5.3</span>
                            </div>
                            <div class="info-item">
                                <label>最后更新</label>
                                <span>2023-10-15</span>
                            </div>
                            <div class="info-item">
                                <label>系统状态</label>
                                <span>运行正常</span>
                            </div>
                        </div>
                        <button class="btn-task">检查更新</button>
                        <button class="btn-task" style="margin-top: 10px;">系统日志</button>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>启敏信息技术（浙江）有限公司 © 2023 IT信息维护系统 v2.5</p>
                <p>7×24小时服务热线: 400-888-9999 | 技术支持: support@qimin-tech.com</p>
            </div>
        </div>
    </div>
    
    <!-- 文件预览模态框 -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">文件预览</h3>
                <div class="close-modal" onclick="closeModal()">&times;</div>
            </div>
            <div class="preview-container" id="previewContainer">
                <!-- 文件预览内容将在这里显示 -->
            </div>
        </div>
    </div>
    
    <!-- 图片预览模态框 -->
    <div class="modal" id="imagePreviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="imagePreviewTitle">图片预览</h3>
                <div class="close-modal" onclick="closeImageModal()">&times;</div>
            </div>
            <div class="preview-container">
                <img id="previewLargeImage" class="preview-large" alt="图片预览">
            </div>
        </div>
    </div>
    
    <!-- 项目详情模态框 -->
    <div class="project-detail-modal" id="projectDetailModal">
        <div class="project-detail-content">
            <div class="modal-header">
                <h3 id="projectDetailTitle">项目详情</h3>
                <div class="close-modal" onclick="closeProjectDetail()">&times;</div>
            </div>
            <div id="projectDetailContent">
                <!-- 项目详情内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 新建维修工单模态框 -->
    <div class="modal" id="newRepairModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="newRepairTitle">新建维修工单</h3>
                <div class="close-modal" onclick="closeNewRepairModal()">&times;</div>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="repairProject">关联项目</label>
                    <select id="repairProject" class="form-control">
                        <option value="">-- 选择项目 --</option>
                        <!-- 项目选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="repairDevice">故障设备</label>
                    <select id="repairDevice" class="form-control">
                        <option value="">-- 选择设备 --</option>
                        <!-- 设备选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="repairTitle">工单标题</label>
                    <input type="text" id="repairTitle" class="form-control" placeholder="请输入工单标题">
                </div>
                
                <div class="form-group">
                    <label for="repairDescription">故障描述</label>
                    <textarea id="repairDescription" class="form-control" rows="4" placeholder="详细描述故障现象..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="repairPriority">优先级</label>
                    <select id="repairPriority" class="form-control">
                        <option value="low">低</option>
                        <option value="medium">中</option>
                        <option value="high">高</option>
                        <option value="urgent">紧急</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="repairEngineer">负责工程师</label>
                    <select id="repairEngineer" class="form-control">
                        <!-- 工程师选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                
                <button class="btn-submit" onclick="createRepair()">创建工单</button>
            </div>
        </div>
    </div>
    
    <!-- 通知消息 -->
    <div class="notification" id="notification">操作成功！</div>
    
    <!-- PDF导出内容容器 -->
    <div id="pdfExportContainer" class="pdf-content"></div>
    
    <script>
        // 全局变量
        let projects = [];
        let currentInspectionDoc = null;
        let currentTopologyFile = null;
        let topologyPreviewUrl = null;
        let devices = [];
        let engineers = [];
        let currentProjectId = null;
        let currentInspection = null;
        let inspectionHistory = {};
        let reports = [];
        let currentReport = null;
        let repairs = [];
        let currentRepair = null;
        let users = [];
        let currentUser = null;
        let db = null;
        let restoreFileContent = null;

        // 初始化IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ITMaintenanceDB', 3);
                
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    
                    // 创建项目存储
                    if (!db.objectStoreNames.contains('projects')) {
                        const projectStore = db.createObjectStore('projects', { keyPath: 'id' });
                        projectStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    // 创建巡检历史存储
                    if (!db.objectStoreNames.contains('inspectionHistory')) {
                        const historyStore = db.createObjectStore('inspectionHistory', { keyPath: 'id' });
                        historyStore.createIndex('projectId', 'projectId', { unique: false });
                    }
                    
                    // 创建报告存储
                    if (!db.objectStoreNames.contains('reports')) {
                        const reportStore = db.createObjectStore('reports', { keyPath: 'id' });
                        reportStore.createIndex('projectId', 'projectId', { unique: false });
                    }
                    
                    // 创建维修工单存储
                    if (!db.objectStoreNames.contains('repairs')) {
                        const repairStore = db.createObjectStore('repairs', { keyPath: 'id' });
                        repairStore.createIndex('projectId', 'projectId', { unique: false });
                    }
                    
                    // 创建用户存储
                    if (!db.objectStoreNames.contains('users')) {
                        const userStore = db.createObjectStore('users', { keyPath: 'id' });
                        userStore.createIndex('username', 'username', { unique: true });
                    }
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    
                    // 检查是否有用户数据
                    const tx = db.transaction(['users'], 'readonly');
                    const store = tx.objectStore('users');
                    const countReq = store.count();
                    
                    countReq.onsuccess = function() {
                        if (countReq.result === 0) {
                            // 添加默认用户
                            addDefaultUsers().then(resolve).catch(reject);
                        } else {
                            resolve();
                        }
                    };
                    
                    countReq.onerror = function() {
                        reject('无法检查用户数据');
                    };
                };
                
                request.onerror = function(event) {
                    console.error('数据库打开失败:', event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // 添加默认用户
        function addDefaultUsers() {
            return new Promise((resolve, reject) => {
                const defaultPassword = "ht886631"; // 默认密码
                const defaultUsers = [
                    {
                        id: 1,
                        username: "manager",
                        password: defaultPassword,
                        fullName: "张经理",
                        role: "manager",
                        permissions: {
                            read: true,
                            write: true,
                            delete: true,
                            admin: false
                        },
                        avatar: "张"
                    },
                    {
                        id: 2,
                        username: "it_support",
                        password: defaultPassword,
                        fullName: "李工程师",
                        role: "it",
                        permissions: {
                            read: true,
                            write: true,
                            delete: true,
                            admin: false
                        },
                        avatar: "李"
                    },
                    {
                        id: 3,
                        username: "business",
                        password: defaultPassword,
                        fullName: "王商务",
                        role: "business",
                        permissions: {
                            read: true,
                            write: true,
                            delete: true,
                            admin: false
                        },
                        avatar: "王"
                    },
                    {
                        id: 4,
                        username: "admin",
                        password: defaultPassword,
                        fullName: "系统管理员",
                        role: "admin",
                        permissions: {
                            read: true,
                            write: true,
                            delete: true,
                            admin: true
                        },
                        avatar: "管"
                    }
                ];
                
                const tx = db.transaction(['users'], 'readwrite');
                const store = tx.objectStore('users');
                
                // 添加所有默认用户
                defaultUsers.forEach(user => {
                    store.put(user);
                });
                
                tx.oncomplete = function() {
                    resolve();
                };
                
                tx.onerror = function(event) {
                    reject('添加默认用户失败: ' + event.target.error);
                };
            });
        }

        // 保存数据到IndexedDB
        function saveData(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('数据库未初始化');
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.put(data);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // 从IndexedDB获取所有数据
        function getAllData(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('数据库未初始化');
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // 从IndexedDB删除数据
        function deleteData(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('数据库未初始化');
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.delete(id);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // 登录功能
function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  fetch('http://localhost:5000/api/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, password })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 登录成功
      currentUser = data.user;

      // 更新用户信息显示
      document.getElementById('userName').textContent = currentUser.full_name;
      document.getElementById('userRole').textContent =
        currentUser.role === 'manager' ? '经理' :
        currentUser.role === 'it' ? 'IT服务人员' :
        currentUser.role === 'business' ? '商务' : '管理员';
      document.getElementById('userAvatar').textContent = currentUser.avatar;

      // 隐藏登录页，显示主系统
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainSystem').style.display = 'block';

      // 加载初始数据
      loadInitialData();
    } else {
      showNotification('用户名或密码错误', true);
    }
  })
  .catch(error => {
    console.error('登录失败:', error);
    showNotification('登录失败', true);
  });
}
        
        // 回车键登录功能
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                login();
            }
        }
        
        // 退出系统
        function logout() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            currentUser = null;
            showNotification('已成功退出系统');
        }
        
        // 更新仪表盘统计
        function updateDashboardStats() {
            // 在维保项目数（状态为active的项目）
            const activeProjects = projects.filter(p => p.status === 'active').length;
            document.getElementById('activeProjectsCount').textContent = activeProjects;
            
            // 本月巡检任务数
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyTasks = projects.filter(project => {
                if (!project.nextInspection) return false;
                
                const inspectionDate = new Date(project.nextInspection);
                return (
                    inspectionDate.getMonth() === currentMonth &&
                    inspectionDate.getFullYear() === currentYear
                );
            }).length;
            
            document.getElementById('monthlyTasksCount').textContent = monthlyTasks;
            
            // 任务完成率
            let completedCount = 0;
            let totalTasks = 0;
            
            projects.forEach(project => {
                if (project.lastInspection) {
                    completedCount++;
                }
                totalTasks++;
            });
            
            const completionRate = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            
            // 待处理维修数
            const pendingRepairs = repairs.filter(repair => repair.status === 'new' || repair.status === 'inProgress').length;
            document.getElementById('repairCount').textContent = pendingRepairs;
        }
        
        // 页面切换功能
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // 更新活动菜单项
                document.querySelectorAll('.nav-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
                
                // 获取目标页面
                const targetPage = this.getAttribute('data-page');
                
                // 隐藏所有页面
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.remove('active');
                });
                
                // 显示目标页面
                document.getElementById(targetPage + 'Page').classList.add('active');
                
                // 更新页面标题
                const pageTitles = {
                    'home': '公司概况',
                    'newProject': '新建项目',
                    'projectManagement': '项目管理',
                    'inspectionTasks': '巡检任务',
                    'reports': '巡检报告',
                    'repairWork': '维修工单',
                    'systemSettings': '系统设置'
                };
                
                document.getElementById('pageTitle').textContent = pageTitles[targetPage];
                
                // 刷新相关页面数据
                if (targetPage === 'projectManagement') renderProjects();
                if (targetPage === 'inspectionTasks') renderTasks();
                if (targetPage === 'reports') renderReports();
                if (targetPage === 'repairWork') renderRepairs();
                if (targetPage === 'home') updateDashboardStats();
                if (targetPage === 'systemSettings') renderUsers();
            });
        });
        
        // 文件上传处理
        document.getElementById('inspectionDoc').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('inspectionDocName').textContent = file.name;
                currentInspectionDoc = file;
                document.getElementById('removeInspectionDoc').style.display = 'block';
            }
        });
        
        // 删除巡检文档
        document.getElementById('removeInspectionDoc').addEventListener('click', function() {
            document.getElementById('inspectionDocName').textContent = '未选择文件';
            document.getElementById('inspectionDoc').value = '';
            currentInspectionDoc = null;
            this.style.display = 'none';
        });
        
        // 拓扑图上传处理
        function handleTopologyUpload(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('topologyFileName').textContent = file.name;
                currentTopologyFile = file;
                document.getElementById('removeTopology').style.display = 'block';
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    topologyPreviewUrl = event.target.result;
                    
                    // 创建缩略图
                    const img = new Image();
                    img.onload = function() {
                        // 创建缩略图（原始尺寸的1/8）
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const scale = 1/8;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        document.getElementById('topologyThumbnail').src = canvas.toDataURL();
                        document.getElementById('topologyPreview').style.display = 'flex';
                    };
                    img.src = topologyPreviewUrl;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // 删除拓扑图
        function removeTopology() {
            document.getElementById('topologyFileName').textContent = '未选择文件';
            document.getElementById('topologyPreview').style.display = 'none';
            document.getElementById('topologyFile').value = '';
            document.getElementById('removeTopology').style.display = 'none';
            currentTopologyFile = null;
            topologyPreviewUrl = null;
        }
        
        // 预览大图
        function previewLargeImage() {
            if (!topologyPreviewUrl) return;
            
            document.getElementById('previewLargeImage').src = topologyPreviewUrl;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }
        
        // 关闭图片预览模态框
        function closeImageModal() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        }
        
        // 添加工程师
        function addEngineer() {
            const name = document.getElementById('engineerName').value;
            const phone = document.getElementById('engineerPhone').value;
            const position = document.getElementById('engineerPosition').value;
            
            if (!name || !phone) {
                showNotification('请输入工程师姓名和联系方式', true);
                return;
            }
            
            const engineer = {
                id: Date.now(),
                name: name,
                phone: phone,
                position: position || '工程师'
            };
            
            engineers.push(engineer);
            renderEngineers();
            
            // 清空表单
            document.getElementById('engineerName').value = '';
            document.getElementById('engineerPhone').value = '';
            document.getElementById('engineerPosition').value = '';
            
            showNotification('工程师添加成功');
        }
        
        // 渲染工程师列表
        function renderEngineers() {
            const container = document.getElementById('engineersList');
            
            if (engineers.length === 0) {
                container.innerHTML = '暂无工程师';
                return;
            }
            
            container.innerHTML = '';
            engineers.forEach(engineer => {
                const engineerEl = document.createElement('div');
                engineerEl.className = 'engineer-card';
                engineerEl.innerHTML = `
                    <div class="engineer-item">
                        <div class="engineer-info">
                            <div><strong>${engineer.name}</strong> - ${engineer.position}</div>
                            <div>电话: ${engineer.phone}</div>
                        </div>
                        <div class="engineer-actions">
                            <button onclick="removeEngineer(${engineer.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(engineerEl);
            });
        }
        
        // 删除工程师
        function removeEngineer(id) {
            engineers = engineers.filter(engineer => engineer.id !== id);
            renderEngineers();
            showNotification('工程师已删除');
        }
        
        // 添加设备/服务
        function addDevice() {
            const deviceName = document.getElementById('deviceName').value;
            const deviceType = document.getElementById('deviceType').value;
            const deviceModel = document.getElementById('deviceModel').value;
            const deviceSerial = document.getElementById('deviceSerial').value;
            const deviceQuantity = document.getElementById('deviceQuantity').value;
            const deviceLocation = document.getElementById('deviceLocation').value;
            const deviceService = document.getElementById('deviceService').value;
            
            if (!deviceName) {
                showNotification('请输入设备/服务名称', true);
                return;
            }
            
            const device = {
                id: Date.now(),
                name: deviceName,
                type: deviceType,
                model: deviceModel,
                serial: deviceSerial,
                quantity: deviceQuantity,
                location: deviceLocation,
                service: deviceService
            };
            
            devices.push(device);
            renderDevices();
            
            // 清空表单
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('deviceSerial').value = '';
            document.getElementById('deviceQuantity').value = '';
            document.getElementById('deviceLocation').value = '';
            document.getElementById('deviceService').value = '';
            
            showNotification('设备/服务添加成功');
        }
        
        // 渲染设备/服务列表
        function renderDevices() {
            const container = document.getElementById('devicesContainer');
            
            if (devices.length === 0) {
                container.innerHTML = '暂无设备/服务';
                return;
            }
            
            container.innerHTML = '';
            devices.forEach(device => {
                // 获取设备类型名称
                const typeNames = {
                    'server': '服务器',
                    'network': '网络设备',
                    'storage': '存储设备',
                    'security': '安全设备',
                    'other': '其他设备/服务'
                };
                
                const typeName = typeNames[device.type] || device.type;
                
                const deviceEl = document.createElement('div');
                deviceEl.className = 'device-item';
                deviceEl.innerHTML = `
                    <div class="device-info">
                        <div><strong>${device.name}</strong> - ${typeName} (${device.quantity || '1台'})</div>
                        <div>型号: ${device.model || '未填写'}, 位置: ${device.location || '未填写'}</div>
                    </div>
                    <div class="device-actions">
                        <button onclick="removeDevice(${device.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(deviceEl);
            });
        }
        
        // 删除设备
        function removeDevice(id) {
            devices = devices.filter(device => device.id !== id);
            renderDevices();
            showNotification('设备/服务已删除');
        }
        
        // 计算下次巡检日期
        function calculateNextInspection(startDate, frequency) {
            const date = new Date(startDate);
            
            switch(frequency) {
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + 3);
                    break;
                case 'half-year':
                    date.setMonth(date.getMonth() + 6);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + 1);
                    break;
                default:
                    date.setMonth(date.getMonth() + 1);
            }
            
            return date.toISOString().split('T')[0];
        }
        
        // 创建项目
        function createProject() {
            const projectName = document.getElementById('projectName').value;
            const client = document.getElementById('client').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const contactPhone = document.getElementById('contactPhone').value;
            const inspectionContent = document.getElementById('inspectionContent').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const frequency = document.getElementById('frequency').value;
            
            if (!projectName || !client || !contactPerson || !contactPhone || !startDate) {
                showNotification('请填写必填字段', true);
                return;
            }
            
            if (engineers.length === 0) {
                showNotification('请至少添加一名服务工程师', true);
                return;
            }
            
            if (devices.length === 0) {
                showNotification('请至少添加一个设备/服务', true);
                return;
            }
            
            // 计算下次巡检日期
            const nextInspection = calculateNextInspection(startDate, frequency);
            
            // 处理文件上传
            let inspectionDocContent = null;
            let topologyFileContent = null;
            
            if (currentInspectionDoc) {
                const reader = new FileReader();
                reader.onload = function() {
                    inspectionDocContent = reader.result;
                    createProjectFinal();
                };
                reader.readAsDataURL(currentInspectionDoc);
            } else {
                createProjectFinal();
            }
            
            if (currentTopologyFile) {
                const reader = new FileReader();
                reader.onload = function() {
                    topologyFileContent = reader.result;
                    createProjectFinal();
                };
                reader.readAsDataURL(currentTopologyFile);
            } else {
                createProjectFinal();
            }
            
            function createProjectFinal() {
                // 创建项目对象
                const project = {
                    id: Date.now(),
                    name: projectName,
                    client: client,
                    contactPerson: contactPerson,
                    contactPhone: contactPhone,
                    engineers: [...engineers],
                    inspectionContent: inspectionContent,
                    startDate: startDate,
                    endDate: endDate,
                    frequency: frequency,
                    nextInspection: nextInspection,
                    devices: [...devices],
                    status: 'active',
                    created: new Date().toISOString(),
                    lastInspection: null,
                    inspectionDoc: currentInspectionDoc ? currentInspectionDoc.name : null,
                    inspectionDocContent: inspectionDocContent,
                    topologyFile: currentTopologyFile ? currentTopologyFile.name : null,
                    topologyFileContent: topologyFileContent
                };
                
                // 保存到IndexedDB
                saveData('projects', project).then(() => {
                    projects.push(project);
                    
                    // 重置表单
                    document.getElementById('projectName').value = '';
                    document.getElementById('client').value = '';
                    document.getElementById('contactPerson').value = '';
                    document.getElementById('contactPhone').value = '';
                    document.getElementById('inspectionContent').value = '';
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    document.getElementById('frequency').selectedIndex = 0;
                    document.getElementById('inspectionDocName').textContent = '未选择文件';
                    document.getElementById('topologyFileName').textContent = '未选择文件';
                    document.getElementById('topologyPreview').style.display = 'none';
                    document.getElementById('removeInspectionDoc').style.display = 'none';
                    document.getElementById('removeTopology').style.display = 'none';
                    engineers = [];
                    renderEngineers();
                    devices = [];
                    renderDevices();
                    currentInspectionDoc = null;
                    currentTopologyFile = null;
                    topologyPreviewUrl = null;
                    
                    // 更新统计
                    updateDashboardStats();
                    
                    // 切换到项目管理页面
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelector('.nav-item[data-page="projectManagement"]').classList.add('active');
                    document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                    document.getElementById('projectManagementPage').classList.add('active');
                    document.getElementById('pageTitle').textContent = '项目管理';
                    
                    renderProjects();
                    showNotification('项目创建成功！');
                }).catch(error => {
                    console.error('保存项目失败:', error);
                    showNotification('保存项目失败', true);
                });
            }
        }
        
        // 渲染项目列表
        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '';
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="no-projects" style="text-align: center; padding: 30px; color: #a0aec0;">暂无项目数据</p>';
                return;
            }
            
            projects.forEach(project => {
                const projectEl = document.createElement('div');
                projectEl.className = 'card';
                projectEl.innerHTML = `
                    <div class="card-header">
                        <h3>${project.name}</h3>
                        <div class="status-badge ${project.status === 'active' ? 'status-active' : 'status-pending'}">${project.status === 'active' ? '进行中' : '待续约'}</div>
                    </div>
                    <div class="project-info">
                        <div class="info-item">
                            <label>甲方单位</label>
                            <span>${project.client}</span>
                        </div>
                        <div class="info-item">
                            <label>联系人</label>
                            <span>${project.contactPerson} (${project.contactPhone})</span>
                        </div>
                        <div class="info-item">
                            <label>服务工程师</label>
                            <span>${project.engineers.length} 人</span>
                        </div>
                        <div class="info-item">
                            <label>下次巡检</label>
                            <span>${project.nextInspection || '未设置'}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-task" onclick="viewProject(${project.id})">查看详情</button>
                        <button class="btn-task" style="background: rgba(220, 53, 69, 0.2); border-color: rgba(220, 53, 69, 0.5); color: var(--danger);" onclick="deleteProject(${project.id})">删除项目</button>
                    </div>
                `;
                container.appendChild(projectEl);
            });
        }
        
        // 渲染巡检任务
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '';
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="no-tasks" style="text-align: center; padding: 30px; color: #a0aec0;">暂无巡检任务</p>';
                return;
            }
            
            // 为每个项目生成一个任务
            projects.forEach(project => {
                // 获取项目历史记录
                getAllData('inspectionHistory').then(history => {
                    const projectHistory = history.filter(i => i.projectId === project.id);
                    const lastInspection = projectHistory.length > 0 ? projectHistory[projectHistory.length - 1] : null;
                    
                    // 计算进度
                    let progress = 0;
                    if (lastInspection) {
                        progress = lastInspection.progress || 0;
                    }
                    
                    const projectEl = document.createElement('div');
                    projectEl.className = 'task-card';
                    projectEl.innerHTML = `
                        <h4>${project.client} - ${project.name}</h4>
                        <div class="task-meta">
                            <span><i class="fas fa-calendar-alt"></i> ${project.nextInspection || '未设置'}</span>
                            <span><i class="fas fa-user"></i> ${project.engineers.length} 名工程师</span>
                        </div>
                        <div class="task-progress">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="task-meta">
                            <span>${Math.floor(progress)}% 完成</span>
                            <span>${project.frequency === 'monthly' ? '月度巡检' : project.frequency === 'quarterly' ? '季度巡检' : project.frequency === 'half-year' ? '半年巡检' : '年度巡检'}</span>
                        </div>
                        <button class="btn-task" onclick="startInspection(${project.id})">${progress === 100 ? '查看报告' : progress > 0 ? '继续巡检' : '开始巡检'}</button>
                    `;
                    container.appendChild(projectEl);
                }).catch(error => {
                    console.error('加载巡检历史失败:', error);
                });
            });
        }
        
        // 查看项目详情
        function viewProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            // 更新模态框标题
            document.getElementById('projectDetailTitle').textContent = `${project.client} - ${project.name} 项目详情`;
            
            // 生成项目详情内容
            let engineerNames = project.engineers.map(e => e.name).join(', ');
            let deviceCounts = {};
            
            project.devices.forEach(device => {
                if (!deviceCounts[device.type]) {
                    deviceCounts[device.type] = 0;
                }
                deviceCounts[device.type]++;
            });
            
            let deviceSummary = Object.entries(deviceCounts).map(([type, count]) => {
                const typeNames = {
                    'server': '服务器',
                    'network': '网络设备',
                    'storage': '存储设备',
                    'security': '安全设备',
                    'other': '其他设备/服务'
                };
                return `${typeNames[type] || type}: ${count}个`;
            }).join('<br>');
            
            // 文件预览链接
            let inspectionDocLink = project.inspectionDoc ? 
                `<div class="file-preview-link" onclick="previewFile('${project.inspectionDoc}', '${project.inspectionDocContent}')">
                    <i class="fas fa-file"></i> ${project.inspectionDoc}
                </div>` : 
                '<p>未上传巡检文档</p>';
            
            let topologyImage = project.topologyFileContent ? 
                `<img src="${project.topologyFileContent}" class="thumbnail" alt="拓扑图" style="max-width: 100%; max-height: 300px; cursor: pointer;" onclick="previewImage('${project.topologyFileContent}')">` : 
                '<p>未上传拓扑图</p>';
            
            document.getElementById('projectDetailContent').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>项目名称</label>
                        <p>${project.name}</p>
                    </div>
                    <div class="form-group">
                        <label>甲方单位</label>
                        <p>${project.client}</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>联系人</label>
                        <p>${project.contactPerson} (${project.contactPhone})</p>
                    </div>
                    <div class="form-group">
                        <label>服务工程师</label>
                        <p>${engineerNames}</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>巡检开始日期</label>
                        <p>${project.startDate}</p>
                    </div>
                    <div class="form-group">
                        <label>巡检结束日期</label>
                        <p>${project.endDate || '未设置'}</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>巡检频率</label>
                    <p>${project.frequency === 'monthly' ? '每月一次' : 
                       project.frequency === 'quarterly' ? '每季度一次' : 
                       project.frequency === 'half-year' ? '每半年一次' : 
                       '每年一次'}</p>
                </div>
                
                <div class="form-group">
                    <label>下次巡检日期</label>
                    <p>${project.nextInspection || '未设置'}</p>
                </div>
                
                <div class="form-group">
                    <label>巡检内容</label>
                    <p>${project.inspectionContent || '未填写'}</p>
                </div>
                
                <div class="form-group">
                    <label>巡检文档</label>
                    ${inspectionDocLink}
                </div>
                
                <div class="form-group">
                    <label>系统拓扑图</label>
                    ${topologyImage}
                </div>
                
                <div class="form-group">
                    <label>设备/服务列表</label>
                    <p>${deviceSummary}</p>
                    <div id="projectDeviceList" style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: rgba(10,25,41,0.5); padding: 10px; border-radius: 8px;">
                        ${project.devices.map(device => {
                            const typeNames = {
                                'server': '服务器',
                                'network': '网络设备',
                                'storage': '存储设备',
                                'security': '安全设备',
                                'other': '其他设备/服务'
                            };
                            return `<div>${device.name} (${typeNames[device.type] || device.type}) - ${device.quantity || '1台'}</div>`;
                        }).join('')}
                    </div>
                </div>
                
                <div class="form-group" style="text-align: center; margin-top: 20px;">
                    <button class="btn-task" onclick="closeProjectDetail()">关闭</button>
                </div>
            `;
            
            // 显示项目详情模态框
            document.getElementById('projectDetailModal').style.display = 'flex';
        }
        
        // 关闭项目详情
        function closeProjectDetail() {
            document.getElementById('projectDetailModal').style.display = 'none';
        }
        
        // 删除项目
        function deleteProject(id) {
            if (confirm('确定要删除这个项目吗？此操作不可恢复！')) {
                deleteData('projects', id).then(() => {
                    projects = projects.filter(p => p.id !== id);
                    renderProjects();
                    updateDashboardStats();
                    showNotification('项目已删除');
                }).catch(error => {
                    console.error('删除项目失败:', error);
                    showNotification('删除项目失败', true);
                });
            }
        }
        
        // 开始巡检
        function startInspection(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            currentProjectId = project.id;
            
            // 获取巡检记录
            getAllData('inspectionHistory').then(history => {
                // 查找该项目的巡检记录
                const projectHistory = history.filter(i => i.projectId === project.id);
                
                // 查找未完成的巡检记录
                currentInspection = projectHistory.find(i => i.status === 'inProgress');
                
                if (!currentInspection) {
                    // 创建新的巡检记录
                    currentInspection = {
                        id: Date.now(),
                        projectId: project.id,
                        date: new Date().toISOString().split('T')[0],
                        status: 'inProgress',
                        progress: 0,
                        steps: generateInspectionSteps(project),
                        images: []
                    };
                    
                    // 保存到IndexedDB
                    saveData('inspectionHistory', currentInspection).then(() => {
                        // 切换到巡检详情页面
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                        document.getElementById('inspectionDetailPage').classList.add('active');
                        document.getElementById('pageTitle').textContent = '巡检任务详情';
                        
                        renderInspectionDetail();
                    }).catch(error => {
                        console.error('创建巡检记录失败:', error);
                        showNotification('创建巡检记录失败', true);
                    });
                } else {
                    // 切换到巡检详情页面
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                    document.getElementById('inspectionDetailPage').classList.add('active');
                    document.getElementById('pageTitle').textContent = '巡检任务详情';
                    
                    renderInspectionDetail();
                }
            }).catch(error => {
                console.error('加载巡检历史失败:', error);
                showNotification('加载巡检历史失败', true);
            });
        }
        
        // 生成巡检步骤
        function generateInspectionSteps(project) {
            const steps = [];
            
            // 通用步骤
            steps.push({
                title: '前期准备',
                description: '检查工具和文档是否齐全，确认巡检计划',
                content: '',
                result: '',
                completed: false,
                images: []
            });
            
            // 根据设备类型生成特定步骤
            project.devices.forEach(device => {
                let step = {
                    title: `巡检设备: ${device.name}`,
                    description: '',
                    content: '',
                    result: '',
                    completed: false,
                    images: []
                };
                
                switch(device.type) {
                    case 'server':
                        step.description = '服务器硬件状态检查、系统日志分析、性能监控';
                        step.content = '1. 检查服务器电源状态\n2. 检查风扇运行状态\n3. 检查硬盘健康状态\n4. 检查CPU和内存使用率\n5. 分析系统日志错误信息';
                        break;
                    case 'network':
                        step.description = '网络设备状态检查、端口状态、配置备份';
                        step.content = '1. 检查设备指示灯状态\n2. 检查端口连接状态\n3. 检查设备CPU和内存使用率\n4. 备份设备配置\n5. 检查网络连通性';
                        break;
                    case 'storage':
                        step.description = '存储设备状态、磁盘健康、空间使用情况';
                        step.content = '1. 检查存储设备状态\n2. 检查磁盘健康状态\n3. 检查存储空间使用率\n4. 检查RAID状态\n5. 检查备份任务状态';
                        break;
                    case 'security':
                        step.description = '安全设备日志分析、规则更新、漏洞扫描';
                        step.content = '1. 分析安全设备日志\n2. 检查安全规则更新\n3. 执行漏洞扫描\n4. 检查入侵检测状态\n5. 检查防火墙状态';
                        break;
                    default:
                        step.description = '设备常规检查';
                        step.content = '1. 设备外观检查\n2. 电源状态检查\n3. 网络连接检查\n4. 运行状态检查\n5. 日志分析';
                }
                
                steps.push(step);
            });
            
            // 最终步骤
            steps.push({
                title: '巡检总结',
                description: '整理巡检结果，编写巡检报告',
                content: '',
                result: '',
                completed: false,
                images: []
            });
            
            return steps;
        }
        
        // 渲染巡检详情
        function renderInspectionDetail() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project || !currentInspection) return;
            
            // 更新项目信息
            document.getElementById('inspectionProjectInfo').innerHTML = `
                <p><strong>项目名称:</strong> ${project.name} | <strong>甲方单位:</strong> ${project.client}</p>
                <p><strong>巡检日期:</strong> ${currentInspection.date} | <strong>巡检进度:</strong> ${currentInspection.progress}%</p>
            `;
            
            // 渲染巡检步骤
            const container = document.getElementById('inspectionStepsContainer');
            container.innerHTML = '';
            
            currentInspection.steps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'inspection-form';
                stepEl.innerHTML = `
                    <div class="inspection-step">
                        <h4>${index + 1}. ${step.title}</h4>
                        <p>${step.description}</p>
                        
                        <div class="step-content">
                            <div>
                                <label>巡检内容</label>
                                <textarea id="step-content-${index}" class="form-control" rows="5" placeholder="请输入巡检内容..." oninput="updateStepContent(${index}, this.value)">${step.content || ''}</textarea>
                            </div>
                            <div>
                                <label>巡检结果</label>
                                <textarea id="step-result-${index}" class="form-control" rows="5" placeholder="请输入巡检结果..." oninput="updateStepResult(${index}, this.value)">${step.result || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="image-upload-container">
                            <label>上传图片</label>
                            <input type="file" id="step-image-${index}" class="file-input" accept="image/*" multiple onchange="handleImageUpload(event, ${index})">
                            <label for="step-image-${index}" class="file-upload-btn">
                                <i class="fas fa-upload"></i> 上传图片
                            </label>
                            
                            <div class="image-preview-container" id="step-images-${index}">
                                ${renderStepImages(step.images || [])}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <input type="checkbox" id="step-completed-${index}" ${step.completed ? 'checked' : ''} onchange="toggleStepCompletion(${index}, this.checked)">
                            <label for="step-completed-${index}">标记为已完成</label>
                        </div>
                        
                        <button class="btn-task btn-repair" onclick="reportRepair(${index})">
                            <i class="fas fa-wrench"></i> 报修设备
                        </button>
                    </div>
                `;
                container.appendChild(stepEl);
            });
            
            // 渲染历史记录
            renderInspectionHistory();
        }
        
        // 更新步骤内容
        function updateStepContent(stepIndex, value) {
            if (currentInspection && currentInspection.steps[stepIndex]) {
                currentInspection.steps[stepIndex].content = value;
            }
        }
        
        // 更新步骤结果
        function updateStepResult(stepIndex, value) {
            if (currentInspection && currentInspection.steps[stepIndex]) {
                currentInspection.steps[stepIndex].result = value;
            }
        }
        
        // 切换步骤完成状态
        function toggleStepCompletion(stepIndex, completed) {
            if (currentInspection && currentInspection.steps[stepIndex]) {
                currentInspection.steps[stepIndex].completed = completed;
                
                // 计算进度
                const completedSteps = currentInspection.steps.filter(step => step.completed).length;
                currentInspection.progress = Math.round((completedSteps / currentInspection.steps.length) * 100);
            }
        }
        
        // 渲染步骤图片
        function renderStepImages(images) {
            if (!images || images.length === 0) return '<span>无图片</span>';
            
            return images.map((img, imgIndex) => `
                <div class="image-preview">
                    <img src="${img.thumbnail}" alt="巡检图片" onclick="previewImage('${img.url}')">
                    <div class="remove-image" onclick="removeStepImage(${index}, ${imgIndex})">×</div>
                </div>
            `).join('');
        }
        
        // 渲染巡检历史
        function renderInspectionHistory() {
            const container = document.getElementById('inspectionHistoryList');
            
            getAllData('inspectionHistory').then(history => {
                // 过滤出当前项目的已完成巡检记录
                const completedHistory = history.filter(i => 
                    i.projectId === currentProjectId && 
                    i.status === 'completed' &&
                    i.id !== (currentInspection ? currentInspection.id : null)
                );
                
                if (completedHistory.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">暂无历史巡检记录</p>';
                    return;
                }
                
                container.innerHTML = '';
                completedHistory.forEach(inspection => {
                    const historyEl = document.createElement('div');
                    historyEl.className = 'history-item';
                    historyEl.innerHTML = `
                        <div class="history-header">
                            <strong>巡检日期: ${inspection.date}</strong>
                            <div>
                                <span>完成进度: ${inspection.progress}%</span>
                                <button class="delete-history-btn" onclick="deleteInspectionHistory(${inspection.id})">删除</button>
                            </div>
                        </div>
                        <div class="history-content">
                            <p>${inspection.summary || '无总结内容'}</p>
                        </div>
                        <div class="history-images">
                            ${inspection.images && inspection.images.length > 0 ? 
                                inspection.images.map(img => `
                                    <img src="${img.thumbnail}" class="history-image" onclick="previewImage('${img.url}')">
                                `).join('') : 
                                '<span>无图片记录</span>'
                            }
                        </div>
                    `;
                    container.appendChild(historyEl);
                });
            }).catch(error => {
                console.error('加载历史记录失败:', error);
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">加载历史记录失败</p>';
            });
        }
        
        // 处理图片上传
        function handleImageUpload(e, stepIndex) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            // 确保当前步骤有图片数组
            if (!currentInspection.steps[stepIndex].images) {
                currentInspection.steps[stepIndex].images = [];
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const url = event.target.result;
                    
                    // 创建缩略图
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 缩略图尺寸为原图的1/10
                        const scale = 0.1;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const thumbnail = canvas.toDataURL();
                        
                        // 添加到当前步骤
                        currentInspection.steps[stepIndex].images.push({
                            url: url,
                            thumbnail: thumbnail,
                            name: file.name
                        });
                        
                        // 只更新当前步骤的图片预览
                        updateStepImages(stepIndex);
                    };
                    img.src = url;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // 更新步骤图片
        function updateStepImages(stepIndex) {
            const container = document.getElementById(`step-images-${stepIndex}`);
            if (!container) return;
            
            const step = currentInspection.steps[stepIndex];
            let imagesHTML = '';
            
            if (step.images && step.images.length > 0) {
                step.images.forEach((img, imgIndex) => {
                    imagesHTML += `
                        <div class="image-preview">
                            <img src="${img.thumbnail}" alt="巡检图片" onclick="previewImage('${img.url}')">
                            <div class="remove-image" onclick="removeStepImage(${stepIndex}, ${imgIndex})">×</div>
                        </div>
                    `;
                });
            } else {
                imagesHTML = '<span>无图片</span>';
            }
            
            container.innerHTML = imagesHTML;
        }
        
        // 删除步骤图片
        function removeStepImage(stepIndex, imgIndex) {
            if (!currentInspection) return;
            const step = currentInspection.steps[stepIndex];
            if (step.images && step.images.length > imgIndex) {
                step.images.splice(imgIndex, 1);
                // 更新该步骤的图片预览
                updateStepImages(stepIndex);
            }
        }
        
        // 预览图片
        function previewImage(url) {
            document.getElementById('previewLargeImage').src = url;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }
        
        // 保存巡检进度
        function saveInspection() {
            if (!currentInspection) return;
            
            // 更新步骤内容
            currentInspection.steps.forEach((step, index) => {
                step.content = document.getElementById(`step-content-${index}`).value;
                step.result = document.getElementById(`step-result-${index}`).value;
                step.completed = document.getElementById(`step-completed-${index}`).checked;
            });
            
            // 计算进度
            const completedSteps = currentInspection.steps.filter(step => step.completed).length;
            currentInspection.progress = Math.round((completedSteps / currentInspection.steps.length) * 100);
            
            // 保存到IndexedDB
            saveData('inspectionHistory', currentInspection).then(() => {
                showNotification('巡检进度已保存');
            }).catch(error => {
                console.error('保存巡检进度失败:', error);
                showNotification('保存巡检进度失败', true);
            });
        }
        
        // 完成巡检
        async function completeInspection() {
            if (!currentInspection) return;

            try {
                // 更新步骤内容
                currentInspection.steps.forEach((step, index) => {
                    step.content = document.getElementById(`step-content-${index}`).value;
                    step.result = document.getElementById(`step-result-${index}`).value;
                    step.completed = true;
                });
                
                currentInspection.progress = 100;
                currentInspection.status = 'completed';
                currentInspection.completedDate = new Date().toISOString();
                currentInspection.summary = "本次巡检已完成，所有设备运行正常";

                // 更新项目下次巡检日期
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    project.nextInspection = calculateNextInspection(project.nextInspection || project.startDate, project.frequency);
                    project.lastInspection = new Date().toISOString().split('T')[0];

                    // 更新项目数据
                    await saveData('projects', project);
                    // 更新本地项目数组
                    const index = projects.findIndex(p => p.id === project.id);
                    if (index !== -1) {
                        projects[index] = project;
                    }
                }

                // 保存巡检记录
                await saveData('inspectionHistory', currentInspection);

                // 生成报告
                try {
                    const newReport = await generateReport(currentInspection.id);
                    if (newReport) {
                        // 保存报告
                        await saveData('reports', newReport);
                        reports.push(newReport);

                        showNotification('巡检任务已完成');

                        // 返回巡检任务页面
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        document.querySelector('.nav-item[data-page="inspectionTasks"]').classList.add('active');
                        document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                        document.getElementById('inspectionTasksPage').classList.add('active');
                        document.getElementById('pageTitle').textContent = '巡检任务';

                        // 刷新任务列表
                        renderTasks();
                        updateDashboardStats();
                    }
                } catch (reportError) {
                    console.error('生成或保存报告失败:', reportError);
                    showNotification('生成或保存报告失败: ' + reportError.message, true);
                }
            } catch (error) {
                console.error('完成巡检失败:', error);
                showNotification('完成巡检失败: ' + error.message, true);
            }
        }
        
        // 删除巡检历史记录
        function deleteInspectionHistory(inspectionId) {
            if (!currentProjectId) return;
            
            if (confirm('确定要删除此条巡检记录吗？此操作不可恢复！')) {
                deleteData('inspectionHistory', inspectionId).then(() => {
                    // 从本地缓存中移除
                    inspectionHistory = inspectionHistory.filter(i => i.id !== inspectionId);
                    renderInspectionHistory();
                    showNotification('巡检记录已删除');
                }).catch(error => {
                    console.error('删除巡检记录失败:', error);
                    showNotification('删除巡检记录失败', true);
                });
            }
        }
        
        // 生成报告
        function generateReport(inspectionId) {
            return new Promise(async (resolve, reject) => {
                const project = projects.find(p => p.id === currentProjectId);
                if (!project) {
                    reject(new Error('项目不存在'));
                    return;
                }
                
                try {
                    // 获取完整的巡检记录
                    const inspections = await getAllData('inspectionHistory');
                    const inspection = inspections.find(i => i.id === inspectionId);
                    if (!inspection) {
                        reject(new Error('巡检记录不存在'));
                    }
                    
                    // 创建报告对象
                    const report = {
                        id: Date.now(),
                        projectId: project.id,
                        projectName: project.name,
                        client: project.client,
                        inspectionDate: inspection.date,
                        completedDate: new Date().toISOString().split('T')[0],
                        engineer: project.engineers.map(e => e.name).join(', '),
                        status: 'completed',
                        summary: inspection.summary || '本次巡检完成，所有设备运行正常',
                        steps: [...inspection.steps],
                        images: [...inspection.images],
                        inspectionDoc: project.inspectionDoc,
                        inspectionDocContent: project.inspectionDocContent,
                        topologyFile: project.topologyFile,
                        topologyFileContent: project.topologyFileContent,
                        devices: [...project.devices]
                    };
                    
                    resolve(report);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // 渲染报告列表
        function renderReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '';
            
            if (reports.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 30px; color: #a0aec0;">暂无巡检报告</p>';
                return;
            }
            
            reports.forEach(report => {
                const project = projects.find(p => p.id === report.projectId);
                if (!project) return;
                
                const reportEl = document.createElement('div');
                reportEl.className = 'report-card';
                reportEl.innerHTML = `
                    <h4>${project.client} - ${project.name}</h4>
                    <p><strong>巡检日期:</strong> ${report.inspectionDate}</p>
                    <p><strong>完成日期:</strong> ${report.completedDate}</p>
                    <p><strong>负责人:</strong> ${report.engineer}</p>
                    <div class="status status-completed">已完成</div>
                    <div class="actions">
                        <button class="btn-task" onclick="viewReport(${report.id})">
                            <i class="fas fa-eye"></i> 查看报告
                        </button>
                        <button class="btn-task btn-export" onclick="exportReport(${report.id})">
                            <i class="fas fa-download"></i> 导出
                        </button>
                        <button class="btn-task btn-delete" onclick="deleteReport(${report.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                `;
                container.appendChild(reportEl);
            });
        }
        
        // 查看报告详情
        function viewReport(reportId) {
            currentReport = reports.find(r => r.id === reportId);
            if (!currentReport) return;
            
            const project = projects.find(p => p.id === currentReport.projectId);
            if (!project) return;
            
            // 更新页面标题
            document.getElementById('reportTitle').textContent = `${project.client} - ${project.name} 巡检报告`;
            document.getElementById('reportSubtitle').textContent = `生成日期: ${currentReport.completedDate}`;
            
            // 文件预览链接
            let inspectionDocLink = currentReport.inspectionDocContent ? 
                `<div class="file-preview-link" onclick="previewFile('${currentReport.inspectionDoc}', '${currentReport.inspectionDocContent}')">
                    <i class="fas fa-file"></i> ${currentReport.inspectionDoc}
                </div>` : 
                '<p>无巡检文档</p>';
            
            let topologyImage = currentReport.topologyFileContent ? 
                `<img src="${currentReport.topologyFileContent}" class="report-image" alt="拓扑图" style="max-width: 100%; max-height: 300px; cursor: pointer;" onclick="previewImage('${currentReport.topologyFileContent}')">` : 
                '<p>无拓扑图</p>';
            
            // 构建报告内容
            const container = document.getElementById('reportContent');
            container.innerHTML = `
                <div class="report-section">
                    <h4>项目信息</h4>
                    <div class="report-info-grid">
                        <div class="report-info-item">
                            <label>项目名称</label>
                            <span>${project.name}</span>
                        </div>
                        <div class="report-info-item">
                            <label>甲方单位</label>
                            <span>${project.client}</span>
                        </div>
                        <div class="report-info-item">
                            <label>联系人</label>
                            <span>${project.contactPerson} (${project.contactPhone})</span>
                        </div>
                        <div class="report-info-item">
                            <label>服务工程师</label>
                            <span>${currentReport.engineer}</span>
                        </div>
                        <div class="report-info-item">
                            <label>巡检日期</label>
                            <span>${currentReport.inspectionDate}</span>
                        </div>
                        <div class="report-info-item">
                            <label>报告生成日期</label>
                            <span>${currentReport.completedDate}</span>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h4>巡检文档</h4>
                    ${inspectionDocLink}
                </div>
                
                <div class="report-section">
                    <h4>系统拓扑图</h4>
                    ${topologyImage}
                </div>
                
                <div class="report-section">
                    <h4>巡检设备列表</h4>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>设备名称</th>
                                <th>类型</th>
                                <th>型号/版本</th>
                                <th>位置</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentReport.devices.map(device => {
                                const typeNames = {
                                    'server': '服务器',
                                    'network': '网络设备',
                                    'storage': '存储设备',
                                    'security': '安全设备',
                                    'other': '其他设备/服务'
                                };
                                
                                return `
                                    <tr>
                                        <td>${device.name}</td>
                                        <td>${typeNames[device.type] || device.type}</td>
                                        <td>${device.model || '-'}</td>
                                        <td>${device.location || '-'}</td>
                                        <td>正常</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="report-section">
                    <h4>巡检详情</h4>
                    ${currentReport.steps.map((step, index) => `
                        <div class="inspection-step">
                            <h4>${index + 1}. ${step.title}</h4>
                            <p>${step.description}</p>
                            
                            <div class="step-content">
                                <div>
                                    <label>巡检内容</label>
                                    <p>${step.content ? step.content.replace(/\n/g, '<br>') : '无内容'}</p>
                                </div>
                                <div>
                                    <label>巡检结果</label>
                                    <p>${step.result ? step.result.replace(/\n/g, '<br>') : '无结果记录'}</p>
                                </div>
                            </div>
                            
                            <div class="image-preview-container">
                                ${step.images && step.images.length > 0 ? 
                                    step.images.map(img => `
                                        <img src="${img.thumbnail}" class="history-image" onclick="previewImage('${img.url}')">
                                    `).join('') : 
                                    '<span>无图片记录</span>'
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="report-section">
                    <h4>巡检总结</h4>
                    <div class="report-summary">
                        <p>${currentReport.summary}</p>
                    </div>
                </div>
            `;
            
            // 切换到报告详情页面
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById('reportDetailPage').classList.add('active');
            document.getElementById('pageTitle').textContent = '巡检报告详情';
        }
        
        // 导出报告为PDF
        function exportReport(reportId) {
            try {
                // 如果没有指定reportId，使用当前报告
                const report = reportId ? reports.find(r => r.id === reportId) : currentReport;
                if (!report) {
                    showNotification('报告不存在，无法导出', true);
                    return;
                }

                const project = projects.find(p => p.id === report.projectId);
                if (!project) {
                    showNotification('关联的项目不存在，无法导出', true);
                    return;
                }

                // 创建临时容器用于导出
                const pdfContainer = document.getElementById('pdfExportContainer');
                pdfContainer.innerHTML = '';
                
                // 创建报告副本
                const reportClone = document.getElementById('reportContent').cloneNode(true);
                reportClone.style.width = '210mm';
                reportClone.style.background = 'white';
                reportClone.style.color = 'black';
                reportClone.style.padding = '20px';
                reportClone.style.boxSizing = 'border-box';
                reportClone.style.fontSize = '14px'; // 设置基本字体大小
                
                // 放大报告中的图片
                const images = reportClone.querySelectorAll('img');
                images.forEach(img => {
                    // 保存原始尺寸
                    const originalWidth = img.width;
                    const originalHeight = img.height;
                    img.setAttribute('data-original-width', originalWidth);
                    img.setAttribute('data-original-height', originalHeight);
                    // 放大两倍
                    img.style.width = (originalWidth * 2) + 'px';
                    img.style.height = (originalHeight * 2) + 'px';
                });
                
                // 添加到容器
                pdfContainer.appendChild(reportClone);
                
                // 使用html2canvas截图
                html2canvas(pdfContainer, {
                    scale: 2, // 提高清晰度
                    useCORS: true,
                    allowTaint: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.92);
                    const imgWidth = 210; // 毫米 (A4宽度)
                    const imgHeight = (canvas.height * imgWidth) / canvas.width; // 毫米
                    
                    const doc = new jspdf.jsPDF('p', 'mm', 'a4');
                    const pageHeight = 297; // 毫米 (A4高度)
                    
                    let position = 0;
                    let pageNum = 0;
                    
                    // 计算总页数
                    const totalPages = Math.ceil(imgHeight / pageHeight);
                    
                    while (position < imgHeight) {
                        if (pageNum > 0) {
                            doc.addPage();
                        }
                        // 当前页显示图片的部分
                        doc.addImage(imgData, 'JPEG', 0, -position, imgWidth, imgHeight);
                        position += pageHeight;
                        pageNum++;
                    }
                    
                    const fileName = `${project.client}-${project.name}-巡检报告-${report.completedDate}.pdf`;
                    doc.save(fileName);
                    
                    // 恢复原始图片尺寸
                    images.forEach(img => {
                        const originalWidth = img.getAttribute('data-original-width');
                        const originalHeight = img.getAttribute('data-original-height');
                        if (originalWidth && originalHeight) {
                            img.style.width = originalWidth + 'px';
                            img.style.height = originalHeight + 'px';
                        }
                    });
                    
                    showNotification('PDF导出成功');
                }).catch(error => {
                    console.error('生成截图失败:', error);
                    showNotification('生成报告失败', true);
                });
            } catch (error) {
                console.error('导出PDF失败:', error);
                showNotification('导出PDF失败: ' + error.message, true);
            }
        }
        
        // 打印报告
        function printReport() {
            if (!currentReport) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>打印报告</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        img { max-width: 100%; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .page-break { page-break-after: always; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; }
                        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
                        .image-grid img { width: 100%; height: auto; }
                    </style>
                </head>
                <body>
                    <h1 style="text-align: center;">${document.getElementById('reportTitle').textContent}</h1>
                    <p style="text-align: center;">${document.getElementById('reportSubtitle').textContent}</p>
                    ${document.getElementById('reportContent').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        
        // 删除报告
        function deleteReport(reportId) {
            // 如果没有指定reportId，使用当前报告
            const idToDelete = reportId || currentReport.id;
            
            if (confirm('确定要删除此报告吗？此操作不可恢复！')) {
                deleteData('reports', idToDelete).then(() => {
                    reports = reports.filter(r => r.id !== idToDelete);
                    
                    if (reportId) {
                        // 在列表页删除
                        renderReports();
                        showNotification('报告已删除');
                    } else {
                        // 在详情页删除
                        backToReportList();
                        showNotification('报告已删除');
                    }
                }).catch(error => {
                    console.error('删除报告失败:', error);
                    showNotification('删除报告失败', true);
                });
            }
        }
        
        // 返回报告列表
        function backToReportList() {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-item[data-page="reports"]').classList.add('active');
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById('reportsPage').classList.add('active');
            document.getElementById('pageTitle').textContent = '巡检报告';
            
            renderReports();
        }
        
        // 报修设备
        function reportRepair(stepIndex) {
            if (!currentInspection || !currentProjectId) return;
            
            const step = currentInspection.steps[stepIndex];
            if (!step) return;
            
            // 获取项目信息
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;
            
            // 提取设备名称
            const deviceName = step.title.replace('巡检设备: ', '');
            
            // 填充新建维修工单表单
            document.getElementById('newRepairTitle').textContent = `报修设备: ${deviceName}`;
            
            // 填充项目选择
            const projectSelect = document.getElementById('repairProject');
            projectSelect.innerHTML = '<option value="">-- 选择项目 --</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                option.selected = p.id === currentProjectId;
                projectSelect.appendChild(option);
            });
            
            // 填充设备选择
            const deviceSelect = document.getElementById('repairDevice');
            deviceSelect.innerHTML = '<option value="">-- 选择设备 --</option>';
            project.devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name;
                option.selected = device.name === deviceName;
                deviceSelect.appendChild(option);
            });
            
            // 填充故障描述
            document.getElementById('repairDescription').value = `设备故障描述:\n${step.result || '巡检过程中发现设备故障'}`;
            
            // 填充工程师选择
            const engineerSelect = document.getElementById('repairEngineer');
            engineerSelect.innerHTML = '';
            project.engineers.forEach(engineer => {
                const option = document.createElement('option');
                option.value = engineer.id;
                option.textContent = engineer.name;
                engineerSelect.appendChild(option);
            });
            
            // 显示新建维修工单模态框
            document.getElementById('newRepairModal').style.display = 'flex';
        }
        
        // 打开新建维修工单表单
        function openNewRepairForm() {
            // 清空表单
            document.getElementById('repairProject').selectedIndex = 0;
            document.getElementById('repairDevice').selectedIndex = 0;
            document.getElementById('repairTitle').value = '';
            document.getElementById('repairDescription').value = '';
            document.getElementById('repairPriority').selectedIndex = 1; // 默认为中
            document.getElementById('repairEngineer').innerHTML = '';
            
            // 填充项目选择
            const projectSelect = document.getElementById('repairProject');
            projectSelect.innerHTML = '<option value="">-- 选择项目 --</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                projectSelect.appendChild(option);
            });
            
            // 显示新建维修工单模态框
            document.getElementById('newRepairTitle').textContent = '新建维修工单';
            document.getElementById('newRepairModal').style.display = 'flex';
        }
        
        // 关闭新建维修工单模态框
        function closeNewRepairModal() {
            document.getElementById('newRepairModal').style.display = 'none';
        }
        
        // 创建维修工单
        function createRepair() {
            const projectId = parseInt(document.getElementById('repairProject').value);
            const deviceId = parseInt(document.getElementById('repairDevice').value);
            const title = document.getElementById('repairTitle').value;
            const description = document.getElementById('repairDescription').value;
            const priority = document.getElementById('repairPriority').value;
            const engineerId = parseInt(document.getElementById('repairEngineer').value);
            
            if (!projectId || !deviceId || !title || !description || !engineerId) {
                showNotification('请填写所有必填字段', true);
                return;
            }
            
            // 获取项目信息
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // 获取设备信息
            const device = project.devices.find(d => d.id === deviceId);
            if (!device) return;
            
            // 获取工程师信息
            const engineer = project.engineers.find(e => e.id === engineerId);
            if (!engineer) return;
            
            // 创建维修工单对象
            const repair = {
                id: Date.now(),
                projectId: projectId,
                deviceId: deviceId,
                title: title,
                description: description,
                priority: priority,
                engineerId: engineerId,
                status: 'new',
                created: new Date().toISOString(),
                completed: null
            };
            
            // 保存到IndexedDB
            saveData('repairs', repair).then(() => {
                repairs.push(repair);
                showNotification('维修工单创建成功');
                closeNewRepairModal();
                renderRepairs();
                updateDashboardStats();
            }).catch(error => {
                console.error('保存维修工单失败:', error);
                showNotification('保存维修工单失败', true);
            });
        }
        
        // 渲染维修工单列表
        function renderRepairs() {
            const container = document.getElementById('repairsContainer');
            container.innerHTML = '';
            
            if (repairs.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 30px; color: #a0aec0;">暂无维修工单</p>';
                return;
            }
            
            repairs.forEach(repair => {
                // 获取项目信息
                const project = projects.find(p => p.id === repair.projectId);
                if (!project) return;
                
                // 获取设备信息
                const device = project.devices.find(d => d.id === repair.deviceId);
                if (!device) return;
                
                // 获取工程师信息
                const engineer = project.engineers.find(e => e.id === repair.engineerId);
                if (!engineer) return;
                
                // 状态文本和样式
                let statusText = '';
                let statusClass = '';
                switch(repair.status) {
                    case 'new':
                        statusText = '新建';
                        statusClass = 'status-new';
                        break;
                    case 'inProgress':
                        statusText = '处理中';
                        statusClass = 'status-in-progress';
                        break;
                    case 'completed':
                        statusText = '已完成';
                        statusClass = 'status-completed';
                        break;
                    default:
                        statusText = '未知状态';
                }
                
                const repairEl = document.createElement('div');
                repairEl.className = 'repair-card';
                repairEl.innerHTML = `
                    <div class="repair-header">
                        <h4>${repair.title}</h4>
                        <div class="status-tag ${statusClass}">${statusText}</div>
                    </div>
                    <div class="repair-info">
                        <div class="repair-info-item">
                            <label>项目</label>
                            <span>${project.name}</span>
                        </div>
                        <div class="repair-info-item">
                            <label>设备</label>
                            <span>${device.name}</span>
                        </div>
                        <div class="repair-info-item">
                            <label>优先级</label>
                            <span>${repair.priority === 'low' ? '低' : 
                                  repair.priority === 'medium' ? '中' : 
                                  repair.priority === 'high' ? '高' : '紧急'}</span>
                        </div>
                        <div class="repair-info-item">
                            <label>工程师</label>
                            <span>${engineer.name}</span>
                        </div>
                    </div>
                    <div class="repair-description">
                        <p>${repair.description}</p>
                    </div>
                    <div class="repair-actions">
                        <button class="btn-task" onclick="viewRepair(${repair.id})">查看详情</button>
                        <button class="btn-task btn-delete" onclick="deleteRepair(${repair.id})">删除</button>
                    </div>
                `;
                container.appendChild(repairEl);
            });
        }
        
        // 查看维修工单详情
        function viewRepair(repairId) {
            currentRepair = repairs.find(r => r.id === repairId);
            if (!currentRepair) return;
            
            // 获取项目信息
            const project = projects.find(p => p.id === currentRepair.projectId);
            if (!project) return;
            
            // 获取设备信息
            const device = project.devices.find(d => d.id === currentRepair.deviceId);
            if (!device) return;
            
            // 获取工程师信息
            const engineer = project.engineers.find(e => e.id === currentRepair.engineerId);
            if (!engineer) return;
            
            // 状态文本和样式
            let statusText = '';
            let statusClass = '';
            switch(currentRepair.status) {
                case 'new':
                    statusText = '新建';
                    statusClass = 'status-new';
                    break;
                case 'inProgress':
                    statusText = '处理中';
                    statusClass = 'status-in-progress';
                    break;
                case 'completed':
                    statusText = '已完成';
                    statusClass = 'status-completed';
                    break;
                default:
                    statusText = '未知状态';
            }
            
            // 构建详情内容
            document.getElementById('repairDetailTitle').textContent = `维修工单: ${currentRepair.title}`;
            document.getElementById('repairProjectInfo').innerHTML = `
                <p><strong>项目:</strong> ${project.name} | <strong>设备:</strong> ${device.name}</p>
            `;
            
            const detailContent = document.getElementById('repairDetailContent');
            detailContent.innerHTML = `
                <div class="repair-info">
                    <div class="repair-info-item">
                        <label>状态</label>
                        <span class="status-tag ${statusClass}">${statusText}</span>
                    </div>
                    <div class="repair-info-item">
                        <label>优先级</label>
                        <span>${currentRepair.priority === 'low' ? '低' : 
                              currentRepair.priority === 'medium' ? '中' : 
                              currentRepair.priority === 'high' ? '高' : '紧急'}</span>
                    </div>
                    <div class="repair-info-item">
                        <label>创建时间</label>
                        <span>${new Date(currentRepair.created).toLocaleString()}</span>
                    </div>
                    <div class="repair-info-item">
                        <label>完成时间</label>
                        <span>${currentRepair.completed ? new Date(currentRepair.completed).toLocaleString() : '未完成'}</span>
                    </div>
                    <div class="repair-info-item">
                        <label>负责工程师</label>
                        <span>${engineer.name} (${engineer.phone})</span>
                    </div>
                </div>
                
                <div class="repair-form-group">
                    <label>故障描述</label>
                    <textarea id="repairDetailDescription" class="form-control" rows="6">${currentRepair.description}</textarea>
                </div>
                
                <div class="repair-form-group">
                    <label>维修过程记录</label>
                    <textarea id="repairProcess" class="form-control" rows="6" placeholder="记录维修过程...">${currentRepair.process || ''}</textarea>
                </div>
                
                <div class="repair-form-group">
                    <label>维修结果</label>
                    <textarea id="repairResult" class="form-control" rows="4" placeholder="记录维修结果...">${currentRepair.result || ''}</textarea>
                </div>
            `;
            
            // 切换到维修详情页面
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById('repairDetailPage').classList.add('active');
            document.getElementById('pageTitle').textContent = '维修工单详情';
        }
        
        // 保存维修工单
        function saveRepair() {
            if (!currentRepair) return;
            
            // 更新维修信息
            currentRepair.description = document.getElementById('repairDetailDescription').value;
            currentRepair.process = document.getElementById('repairProcess').value;
            currentRepair.result = document.getElementById('repairResult').value;
            
            // 保存到IndexedDB
            saveData('repairs', currentRepair).then(() => {
                // 更新本地数据
                const index = repairs.findIndex(r => r.id === currentRepair.id);
                if (index !== -1) {
                    repairs[index] = currentRepair;
                }
                
                showNotification('维修工单已保存');
            }).catch(error => {
                console.error('保存维修工单失败:', error);
                showNotification('保存维修工单失败', true);
            });
        }
        
        // 完成维修
        function completeRepair() {
            if (!currentRepair) return;
            
            // 更新状态
            currentRepair.status = 'completed';
            currentRepair.completed = new Date().toISOString();
            
            // 更新维修信息
            currentRepair.description = document.getElementById('repairDetailDescription').value;
            currentRepair.process = document.getElementById('repairProcess').value;
            currentRepair.result = document.getElementById('repairResult').value;
            
            // 保存到IndexedDB
            saveData('repairs', currentRepair).then(() => {
                // 更新本地数据
                const index = repairs.findIndex(r => r.id === currentRepair.id);
                if (index !== -1) {
                    repairs[index] = currentRepair;
                }
                
                showNotification('维修工单已完成');
                backToRepairList();
                updateDashboardStats();
            }).catch(error => {
                console.error('完成维修工单失败:', error);
                showNotification('完成维修工单失败', true);
            });
        }
        
        // 返回维修工单列表
        function backToRepairList() {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-item[data-page="repairWork"]').classList.add('active');
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById('repairWorkPage').classList.add('active');
            document.getElementById('pageTitle').textContent = '维修工单';
            
            renderRepairs();
        }
        
        // 删除维修工单
        function deleteRepair(repairId) {
            const idToDelete = repairId;
            
            if (confirm('确定要删除此维修工单吗？此操作不可恢复！')) {
                deleteData('repairs', idToDelete).then(() => {
                    repairs = repairs.filter(r => r.id !== idToDelete);
                    
                    if (currentRepair && currentRepair.id === idToDelete) {
                        backToRepairList();
                    } else {
                        renderRepairs();
                    }
                    
                    showNotification('维修工单已删除');
                    updateDashboardStats();
                }).catch(error => {
                    console.error('删除维修工单失败:', error);
                    showNotification('删除维修工单失败', true);
                });
            }
        }
        
        // 渲染用户列表
        function renderUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">暂无用户数据</td></tr>';
                return;
            }
            
            users.forEach(user => {
                // 获取角色名称
                const roleNames = {
                    'manager': '经理',
                    'it': 'IT服务人员',
                    'business': '商务',
                    'admin': '管理员'
                };
                
                const roleName = roleNames[user.role] || user.role;
                
                // 获取角色标签
                const roleClass = {
                    'manager': 'role-manager',
                    'it': 'role-it',
                    'business': 'role-business',
                    'admin': 'role-admin'
                }[user.role] || '';
                
                const userRow = document.createElement('tr');
                userRow.innerHTML = `
                    <td>${user.username} (${user.fullName})</td>
                    <td><span class="role-tag ${roleClass}">${roleName}</span></td>
                    <td>
                        ${user.permissions.read ? '<span class="permission-badge">读</span>' : ''}
                        ${user.permissions.write ? '<span class="permission-badge">写</span>' : ''}
                        ${user.permissions.delete ? '<span class="permission-badge">删</span>' : ''}
                        ${user.permissions.admin ? '<span class="permission-badge">管理</span>' : ''}
                    </td>
                    <td>
                        <button class="btn-task" onclick="editUser(${user.id})">编辑</button>
                        <button class="btn-task btn-delete" onclick="deleteUser(${user.id})">删除</button>
                    </td>
                `;
                container.appendChild(userRow);
            });
        }
        
        // 显示用户表单
        function showUserForm() {
            document.getElementById('userFormContainer').style.display = 'block';
            document.getElementById('userFormTitle').textContent = '添加用户';
            
            // 清空表单
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('fullNameInput').value = '';
            document.getElementById('roleSelect').selectedIndex = 0;
            document.getElementById('permRead').checked = true;
            document.getElementById('permWrite').checked = true;
            document.getElementById('permDelete').checked = true;
            document.getElementById('permAdmin').checked = false;
        }
        
        // 隐藏用户表单
        function hideUserForm() {
            document.getElementById('userFormContainer').style.display = 'none';
        }
        
        // 编辑用户
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('userFormContainer').style.display = 'block';
            document.getElementById('userFormTitle').textContent = '编辑用户';
            
            // 填充表单
            document.getElementById('usernameInput').value = user.username;
            document.getElementById('passwordInput').value = '';
            document.getElementById('fullNameInput').value = user.fullName;
            document.getElementById('roleSelect').value = user.role;
            
            // 设置权限
            document.getElementById('permRead').checked = user.permissions.read;
            document.getElementById('permWrite').checked = user.permissions.write;
            document.getElementById('permDelete').checked = user.permissions.delete;
            document.getElementById('permAdmin').checked = user.permissions.admin;
            
            currentUser = user;
        }
        
        // 保存用户
        function saveUser() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const fullName = document.getElementById('fullNameInput').value;
            const role = document.getElementById('roleSelect').value;
            
            if (!username || !fullName || !role) {
                showNotification('请填写必填字段', true);
                return;
            }
            
            // 检查是添加还是更新
            const isNew = !currentUser;
            
            // 创建用户对象
            const user = {
                id: isNew ? Date.now() : currentUser.id,
                username: username,
                password: password || (isNew ? 'ht886631' : currentUser.password),
                fullName: fullName,
                role: role,
                permissions: {
                    read: document.getElementById('permRead').checked,
                    write: document.getElementById('permWrite').checked,
                    delete: document.getElementById('permDelete').checked,
                    admin: document.getElementById('permAdmin').checked
                },
                avatar: fullName.charAt(0)
            };
            
            // 保存到IndexedDB
            saveData('users', user).then(() => {
                if (isNew) {
                    users.push(user);
                } else {
                    const index = users.findIndex(u => u.id === user.id);
                    if (index !== -1) {
                        users[index] = user;
                    }
                }
                
                // 如果是当前用户更新了信息
                if (currentUser && currentUser.id === user.id) {
                    currentUser = user;
                    document.getElementById('userName').textContent = user.fullName;
                    document.getElementById('userRole').textContent = 
                        user.role === 'manager' ? '经理' : 
                        user.role === 'it' ? 'IT服务人员' : 
                        user.role === 'business' ? '商务' : '管理员';
                    document.getElementById('userAvatar').textContent = user.avatar;
                }
                
                showNotification('用户保存成功');
                hideUserForm();
                renderUsers();
            }).catch(error => {
                console.error('保存用户失败:', error);
                showNotification('保存用户失败', true);
            });
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除此用户吗？此操作不可恢复！')) {
                deleteData('users', userId).then(() => {
                    users = users.filter(u => u.id !== userId);
                    renderUsers();
                    showNotification('用户已删除');
                }).catch(error => {
                    console.error('删除用户失败:', error);
                    showNotification('删除用户失败', true);
                });
            }
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 初始化示例数据
        function initSampleData() {
            // 如果没有项目数据，创建示例项目
            if (projects.length === 0) {
                const sampleProject = {
                    id: 1,
                    name: "绍兴银行数据中心维护项目",
                    client: "绍兴银行",
                    contactPerson: "王经理",
                    contactPhone: "13800138000",
                    engineers: [
                        { id: 1, name: "张工程师", phone: "13900139000", position: "高级工程师" },
                        { id: 2, name: "李工程师", phone: "13700137000", position: "工程师" }
                    ],
                    inspectionContent: "每月对数据中心服务器、网络设备、存储设备进行全面检查",
                    startDate: "2023-01-01",
                    endDate: "2024-12-31",
                    frequency: "monthly",
                    nextInspection: "2023-12-15",
                    devices: [
                        {
                            id: 1,
                            name: "Dell R740服务器",
                            type: "server",
                            model: "PowerEdge R740",
                            serial: "SER123456",
                            quantity: "5台",
                            location: "数据中心A区",
                            service: "硬件维护、系统优化"
                        },
                        {
                            id: 2,
                            name: "Cisco 3850交换机",
                            type: "network",
                            model: "WS-C3850-48T",
                            serial: "NET789012",
                            quantity: "3台",
                            location: "网络机房",
                            service: "配置检查、固件升级"
                        }
                    ],
                    status: "active",
                    created: "2023-01-01",
                    lastInspection: "2023-11-15"
                };
                
                projects.push(sampleProject);
                saveData('projects', sampleProject);
                updateDashboardStats();
                renderProjects();
            }
        }
        
        // 文件预览功能
        function previewFile(fileName, fileContent) {
            if (!fileContent) return;
            
            document.getElementById('previewTitle').textContent = `预览文件: ${fileName}`;
            const container = document.getElementById('previewContainer');
            
            // 根据文件类型进行预览
            if (fileName.endsWith('.pdf')) {
                container.innerHTML = `<iframe src="${fileContent}"></iframe>`;
            } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png')) {
                container.innerHTML = `<img src="${fileContent}" alt="${fileName}">`;
            } else {
                container.innerHTML = `<p>不支持预览此文件类型</p>`;
            }
            
            document.getElementById('previewModal').style.display = 'flex';
        }
        
        // 关闭文件预览模态框
        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        // 备份数据
        function backupData() {
            const data = {
                projects: projects,
                reports: reports,
                repairs: repairs,
                users: users
            };
            
            const dataStr = JSON.stringify(data);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `it-maintenance-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('数据备份成功');
        }
        
        // 处理恢复文件
        function handleRestoreFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    restoreFileContent = JSON.parse(event.target.result);
                    document.getElementById('restoreFileName').textContent = file.name;
                    document.getElementById('restoreBtn').disabled = false;
                } catch (error) {
                    console.error('解析备份文件失败:', error);
                    showNotification('备份文件格式错误', true);
                }
            };
            reader.readAsText(file);
        }
        
        // 恢复数据
        function restoreData() {
            if (!restoreFileContent) return;
            
            if (confirm('确定要恢复数据吗？当前所有数据将被覆盖！')) {
                const tx = db.transaction(['projects', 'reports', 'repairs', 'users'], 'readwrite');
                
                // 清空所有存储
                tx.objectStore('projects').clear();
                tx.objectStore('reports').clear();
                tx.objectStore('repairs').clear();
                tx.objectStore('users').clear();
                
                tx.oncomplete = function() {
                    // 保存恢复的数据
                    const savePromises = [];
                    
                    if (restoreFileContent.projects) {
                        projects = restoreFileContent.projects;
                        projects.forEach(project => {
                            savePromises.push(saveData('projects', project));
                        });
                    }
                    
                    if (restoreFileContent.reports) {
                        reports = restoreFileContent.reports;
                        reports.forEach(report => {
                            savePromises.push(saveData('reports', report));
                        });
                    }
                    
                    if (restoreFileContent.repairs) {
                        repairs = restoreFileContent.repairs;
                        repairs.forEach(repair => {
                            savePromises.push(saveData('repairs', repair));
                        });
                    }
                    
                    if (restoreFileContent.users) {
                        users = restoreFileContent.users;
                        users.forEach(user => {
                            savePromises.push(saveData('users', user));
                        });
                    }
                    
                    Promise.all(savePromises).then(() => {
                        showNotification('数据恢复成功');
                        renderProjects();
                        renderReports();
                        renderRepairs();
                        renderUsers();
                        updateDashboardStats();
                    }).catch(error => {
                        console.error('保存恢复数据失败:', error);
                        showNotification('数据恢复失败', true);
                    });
                };
                
                tx.onerror = function(error) {
                    console.error('清空数据库失败:', error);
                    showNotification('恢复数据失败', true);
                };
            }
        }
        
        // 初始化系统
        window.addEventListener('DOMContentLoaded', function() {
            // 初始化IndexedDB
            initDB().catch(error => {
                console.error('数据库初始化失败:', error);
                showNotification('系统初始化失败', true);
            });
        });
    </script>
    <script src="script.js"></script>
</body>
</html>